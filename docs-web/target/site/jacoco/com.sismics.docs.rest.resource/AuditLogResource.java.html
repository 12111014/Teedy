<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuditLogResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Docs Web</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.rest.resource</a> &gt; <span class="el_source">AuditLogResource.java</span></div><h1>AuditLogResource.java</h1><pre class="source lang-java linenums">package com.sismics.docs.rest.resource;

import com.google.common.base.Strings;
import com.sismics.docs.core.constant.PermType;
import com.sismics.docs.core.dao.AclDao;
import com.sismics.docs.core.dao.AuditLogDao;
import com.sismics.docs.core.dao.criteria.AuditLogCriteria;
import com.sismics.docs.core.dao.dto.AuditLogDto;
import com.sismics.docs.core.util.SecurityUtil;
import com.sismics.docs.core.util.jpa.PaginatedList;
import com.sismics.docs.core.util.jpa.PaginatedLists;
import com.sismics.docs.core.util.jpa.SortCriteria;
import com.sismics.rest.exception.ForbiddenClientException;
import com.sismics.util.JsonUtil;

import javax.json.Json;
import javax.json.JsonArrayBuilder;
import javax.json.JsonObjectBuilder;
import javax.ws.rs.GET;
import javax.ws.rs.NotFoundException;
import javax.ws.rs.Path;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.Response;

/**
 * Audit log REST resources.
 * 
 * @author bgamard
 */
@Path(&quot;/auditlog&quot;)
<span class="fc" id="L31">public class AuditLogResource extends BaseResource {</span>
    /**
     * Returns the list of all logs for a document or user.
     *
     * @api {get} /auditlog Get audit logs
     * @apiDescription If no document ID is provided, logs for the current user will be returned.
     * @apiName GetAuditlog
     * @apiGroup Auditlog
     * @apiParam {String} [document] Document ID
     * @apiSuccess {String} total Total number of logs
     * @apiSuccess {Object[]} logs List of logs
     * @apiSuccess {String} logs.id ID
     * @apiSuccess {String} logs.username Username
     * @apiSuccess {String} logs.target Entity ID
     * @apiSuccess {String=&quot;Acl&quot;,&quot;Comment&quot;,&quot;Document&quot;,&quot;File&quot;,&quot;Group&quot;,&quot;Tag&quot;,&quot;User&quot;,&quot;RouteModel&quot;,&quot;Route&quot;} logs.class Entity type
     * @apiSuccess {String=&quot;CREATE&quot;,&quot;UPDATE&quot;,&quot;DELETE&quot;} logs.type Type
     * @apiSuccess {String} logs.message Message
     * @apiSuccess {Number} logs.create_date Create date (timestamp)
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) NotFound Document not found
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @return Response
     */
    @GET
    public Response list(@QueryParam(&quot;document&quot;) String documentId) {
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L59">            throw new ForbiddenClientException();</span>
        }
        
        // On a document or a user?
<span class="fc" id="L63">        PaginatedList&lt;AuditLogDto&gt; paginatedList = PaginatedLists.create(20, 0);</span>
<span class="fc" id="L64">        SortCriteria sortCriteria = new SortCriteria(1, false);</span>
<span class="fc" id="L65">        AuditLogCriteria criteria = new AuditLogCriteria();</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (Strings.isNullOrEmpty(documentId)) {</span>
            // Search logs for a user
<span class="fc" id="L68">            criteria.setUserId(principal.getId());</span>
<span class="fc" id="L69">            criteria.setAdmin(SecurityUtil.skipAclCheck(getTargetIdList(null)));</span>
        } else {
            // Check ACL on the document
<span class="fc" id="L72">            AclDao aclDao = new AclDao();</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">            if (!aclDao.checkPermission(documentId, PermType.READ, getTargetIdList(null))) {</span>
<span class="nc" id="L74">                throw new NotFoundException();</span>
            }
<span class="fc" id="L76">            criteria.setDocumentId(documentId);</span>
        }
        
        // Search the logs
<span class="fc" id="L80">        AuditLogDao auditLogDao = new AuditLogDao();</span>
<span class="fc" id="L81">        auditLogDao.findByCriteria(paginatedList, criteria, sortCriteria);</span>
        
        // Assemble the results
<span class="fc" id="L84">        JsonArrayBuilder logs = Json.createArrayBuilder();</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">        for (AuditLogDto auditLogDto : paginatedList.getResultList()) {</span>
<span class="fc" id="L86">            logs.add(Json.createObjectBuilder()</span>
<span class="fc" id="L87">                    .add(&quot;id&quot;, auditLogDto.getId())</span>
<span class="fc" id="L88">                    .add(&quot;username&quot;, auditLogDto.getUsername())</span>
<span class="fc" id="L89">                    .add(&quot;target&quot;, auditLogDto.getEntityId())</span>
<span class="fc" id="L90">                    .add(&quot;class&quot;, auditLogDto.getEntityClass())</span>
<span class="fc" id="L91">                    .add(&quot;type&quot;, auditLogDto.getType().name())</span>
<span class="fc" id="L92">                    .add(&quot;message&quot;, JsonUtil.nullable(auditLogDto.getMessage()))</span>
<span class="fc" id="L93">                    .add(&quot;create_date&quot;, auditLogDto.getCreateTimestamp()));</span>
<span class="fc" id="L94">        }</span>

        // Send the response
<span class="fc" id="L97">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="fc" id="L98">                .add(&quot;logs&quot;, logs)</span>
<span class="fc" id="L99">                .add(&quot;total&quot;, paginatedList.getResultCount());</span>
<span class="fc" id="L100">        return Response.ok().entity(response.build()).build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>