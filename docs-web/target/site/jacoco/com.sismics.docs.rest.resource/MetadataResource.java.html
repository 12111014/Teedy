<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetadataResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Docs Web</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.rest.resource</a> &gt; <span class="el_source">MetadataResource.java</span></div><h1>MetadataResource.java</h1><pre class="source lang-java linenums">package com.sismics.docs.rest.resource;

import com.sismics.docs.core.constant.MetadataType;
import com.sismics.docs.core.dao.MetadataDao;
import com.sismics.docs.core.dao.criteria.MetadataCriteria;
import com.sismics.docs.core.dao.dto.MetadataDto;
import com.sismics.docs.core.model.jpa.Metadata;
import com.sismics.docs.core.util.jpa.SortCriteria;
import com.sismics.docs.rest.constant.BaseFunction;
import com.sismics.rest.exception.ForbiddenClientException;
import com.sismics.rest.util.ValidationUtil;

import javax.json.Json;
import javax.json.JsonArrayBuilder;
import javax.json.JsonObjectBuilder;
import javax.ws.rs.*;
import javax.ws.rs.core.Response;
import java.util.List;

/**
 * Metadata REST resources.
 * 
 * @author bgamard
 */
@Path(&quot;/metadata&quot;)
<span class="nc" id="L26">public class MetadataResource extends BaseResource {</span>
    /**
     * Returns the list of all configured metadata.
     *
     * @api {get} /metadata Get configured metadata
     * @apiName GetMetadata
     * @apiGroup Metadata
     * @apiParam {Number} sort_column Column index to sort on
     * @apiParam {Boolean} asc If true, sort in ascending order
     * @apiSuccess {Object[]} metadata List of metadata
     * @apiSuccess {String} metadata.id ID
     * @apiSuccess {String} metadata.name Name
     * @apiSuccess {String=&quot;STRING&quot;,&quot;INTEGER&quot;,&quot;FLOAT&quot;,&quot;DATE&quot;,&quot;BOOLEAN&quot;} metadata.type Type
     * @apiError (client) ForbiddenError Access denied
     * @apiPermission user
     * @apiVersion 1.7.0
     *
     * @return Response
     */
    @GET
    public Response list(
            @QueryParam(&quot;sort_column&quot;) Integer sortColumn,
            @QueryParam(&quot;asc&quot;) Boolean asc) {
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L50">            throw new ForbiddenClientException();</span>
        }

<span class="nc" id="L53">        JsonArrayBuilder metadata = Json.createArrayBuilder();</span>
<span class="nc" id="L54">        SortCriteria sortCriteria = new SortCriteria(sortColumn, asc);</span>

<span class="nc" id="L56">        MetadataDao metadataDao = new MetadataDao();</span>
<span class="nc" id="L57">        List&lt;MetadataDto&gt; metadataDtoList = metadataDao.findByCriteria(new MetadataCriteria(), sortCriteria);</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        for (MetadataDto metadataDto : metadataDtoList) {</span>
<span class="nc" id="L59">            metadata.add(Json.createObjectBuilder()</span>
<span class="nc" id="L60">                    .add(&quot;id&quot;, metadataDto.getId())</span>
<span class="nc" id="L61">                    .add(&quot;name&quot;, metadataDto.getName())</span>
<span class="nc" id="L62">                    .add(&quot;type&quot;, metadataDto.getType().name()));</span>
<span class="nc" id="L63">        }</span>

<span class="nc" id="L65">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L66">                .add(&quot;metadata&quot;, metadata);</span>
<span class="nc" id="L67">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Add a metadata.
     *
     * @api {put} /metadata Add a custom metadata
     * @apiName PutMetadata
     * @apiGroup Metadata
     * @apiParam {String{1..50}} name Name
     * @apiParam {String=&quot;STRING&quot;,&quot;INTEGER&quot;,&quot;FLOAT&quot;,&quot;DATE&quot;,&quot;BOOLEAN&quot;} type Type
     * @apiSuccess {String} id ID
     * @apiSuccess {String} name Name
     * @apiSuccess {String=&quot;STRING&quot;,&quot;INTEGER&quot;,&quot;FLOAT&quot;,&quot;DATE&quot;,&quot;BOOLEAN&quot;} type Type
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiPermission admin
     * @apiVersion 1.7.0
     *
     * @param name Name
     * @param typeStr Type
     * @return Response
     */
    @PUT
    public Response add(@FormParam(&quot;name&quot;) String name,
                        @FormParam(&quot;type&quot;) String typeStr) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L94">            throw new ForbiddenClientException();</span>
        }
<span class="nc" id="L96">        checkBaseFunction(BaseFunction.ADMIN);</span>

        // Validate input data
<span class="nc" id="L99">        name = ValidationUtil.validateLength(name, &quot;name&quot;, 1, 50, false);</span>
<span class="nc" id="L100">        MetadataType type = MetadataType.valueOf(ValidationUtil.validateLength(typeStr, &quot;type&quot;, 1, 20, false));</span>

        // Create the metadata
<span class="nc" id="L103">        MetadataDao metadataDao = new MetadataDao();</span>
<span class="nc" id="L104">        Metadata metadata = new Metadata();</span>
<span class="nc" id="L105">        metadata.setName(name);</span>
<span class="nc" id="L106">        metadata.setType(type);</span>
<span class="nc" id="L107">        metadataDao.create(metadata, principal.getId());</span>

        // Returns the metadata
<span class="nc" id="L110">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L111">                .add(&quot;id&quot;, metadata.getId())</span>
<span class="nc" id="L112">                .add(&quot;name&quot;, metadata.getName())</span>
<span class="nc" id="L113">                .add(&quot;type&quot;, metadata.getType().name());</span>
<span class="nc" id="L114">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Update a metadata.
     *
     * @api {post} /metadata/:id Update a custom metadata
     * @apiName PostMetadataId
     * @apiGroup Metadata
     * @apiParam {String} id Metadata ID
     * @apiParam {String{1..50}} name Name
     * @apiSuccess {String} id ID
     * @apiSuccess {String} name Name
     * @apiSuccess {String=&quot;STRING&quot;,&quot;INTEGER&quot;,&quot;FLOAT&quot;,&quot;DATE&quot;,&quot;BOOLEAN&quot;} type Type
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiError (client) NotFound Metadata not found
     * @apiPermission admin
     * @apiVersion 1.7.0
     *
     * @param id ID
     * @param name Name
     * @return Response
     */
    @POST
    @Path(&quot;{id: [a-z0-9\\-]+}&quot;)
    public Response update(@PathParam(&quot;id&quot;) String id,
                           @FormParam(&quot;name&quot;) String name) {
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L143">            throw new ForbiddenClientException();</span>
        }
<span class="nc" id="L145">        checkBaseFunction(BaseFunction.ADMIN);</span>

        // Validate input data
<span class="nc" id="L148">        name = ValidationUtil.validateLength(name, &quot;name&quot;, 1, 50, false);</span>

        // Get the metadata
<span class="nc" id="L151">        MetadataDao metadataDao = new MetadataDao();</span>
<span class="nc" id="L152">        Metadata metadata = metadataDao.getActiveById(id);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (metadata == null) {</span>
<span class="nc" id="L154">            throw new NotFoundException();</span>
        }

        // Update the metadata
<span class="nc" id="L158">        metadata.setName(name);</span>
<span class="nc" id="L159">        metadataDao.update(metadata, principal.getId());</span>

        // Returns the metadata
<span class="nc" id="L162">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L163">                .add(&quot;id&quot;, metadata.getId())</span>
<span class="nc" id="L164">                .add(&quot;name&quot;, metadata.getName())</span>
<span class="nc" id="L165">                .add(&quot;type&quot;, metadata.getType().name());</span>
<span class="nc" id="L166">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Delete a metadata.
     *
     * @api {delete} /metadata/:id Delete a custom metadata
     * @apiName DeleteMetadataId
     * @apiGroup Metadata
     * @apiParam {String} id Metadata ID
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) NotFound Metadata not found
     * @apiPermission admin
     * @apiVersion 1.7.0
     *
     * @param id ID
     * @return Response
     */
    @DELETE
    @Path(&quot;{id: [a-z0-9\\-]+}&quot;)
    public Response delete(@PathParam(&quot;id&quot;) String id) {
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L189">            throw new ForbiddenClientException();</span>
        }
<span class="nc" id="L191">        checkBaseFunction(BaseFunction.ADMIN);</span>

        // Get the metadata
<span class="nc" id="L194">        MetadataDao metadataDao = new MetadataDao();</span>
<span class="nc" id="L195">        Metadata metadata = metadataDao.getActiveById(id);</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (metadata == null) {</span>
<span class="nc" id="L197">            throw new NotFoundException();</span>
        }

        // Delete the metadata
<span class="nc" id="L201">        metadataDao.delete(id, principal.getId());</span>

        // Always return OK
<span class="nc" id="L204">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L205">                .add(&quot;status&quot;, &quot;ok&quot;);</span>
<span class="nc" id="L206">        return Response.ok().entity(response.build()).build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>