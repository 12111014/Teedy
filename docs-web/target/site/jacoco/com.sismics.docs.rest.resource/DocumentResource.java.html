<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DocumentResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Docs Web</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.rest.resource</a> &gt; <span class="el_source">DocumentResource.java</span></div><h1>DocumentResource.java</h1><pre class="source lang-java linenums">package com.sismics.docs.rest.resource;

import com.google.common.base.Joiner;
import com.google.common.base.Strings;
import com.google.common.collect.Lists;
import com.sismics.docs.core.constant.AclType;
import com.sismics.docs.core.constant.ConfigType;
import com.sismics.docs.core.constant.Constants;
import com.sismics.docs.core.constant.PermType;
import com.sismics.docs.core.dao.*;
import com.sismics.docs.core.dao.criteria.DocumentCriteria;
import com.sismics.docs.core.dao.criteria.TagCriteria;
import com.sismics.docs.core.dao.dto.*;
import com.sismics.docs.core.event.DocumentCreatedAsyncEvent;
import com.sismics.docs.core.event.DocumentDeletedAsyncEvent;
import com.sismics.docs.core.event.DocumentUpdatedAsyncEvent;
import com.sismics.docs.core.event.FileDeletedAsyncEvent;
import com.sismics.docs.core.model.context.AppContext;
import com.sismics.docs.core.model.jpa.Document;
import com.sismics.docs.core.model.jpa.File;
import com.sismics.docs.core.model.jpa.User;
import com.sismics.docs.core.util.*;
import com.sismics.docs.core.util.jpa.PaginatedList;
import com.sismics.docs.core.util.jpa.PaginatedLists;
import com.sismics.docs.core.util.jpa.SortCriteria;
import com.sismics.rest.exception.ClientException;
import com.sismics.rest.exception.ForbiddenClientException;
import com.sismics.rest.exception.ServerException;
import com.sismics.rest.util.AclUtil;
import com.sismics.rest.util.RestUtil;
import com.sismics.rest.util.ValidationUtil;
import com.sismics.util.EmailUtil;
import com.sismics.util.JsonUtil;
import com.sismics.util.context.ThreadLocalContext;
import com.sismics.util.mime.MimeType;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang.StringUtils;
import org.glassfish.jersey.media.multipart.FormDataBodyPart;
import org.glassfish.jersey.media.multipart.FormDataParam;
import org.joda.time.DateTime;
import org.joda.time.format.DateTimeFormat;
import org.joda.time.format.DateTimeFormatter;
import org.joda.time.format.DateTimeFormatterBuilder;
import org.joda.time.format.DateTimeParser;

import javax.json.Json;
import javax.json.JsonArrayBuilder;
import javax.json.JsonObjectBuilder;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Session;
import javax.mail.internet.MimeMessage;
import javax.ws.rs.*;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.StreamingOutput;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.StandardCopyOption;
import java.text.MessageFormat;
import java.util.*;

/**
 * Document REST resources.
 * 
 * @author bgamard
 */
@Path(&quot;/document&quot;)
<span class="fc" id="L69">public class DocumentResource extends BaseResource {</span>

<span class="fc" id="L71">    protected static final DateTimeParser YEAR_PARSER = DateTimeFormat.forPattern(&quot;yyyy&quot;).getParser();</span>
<span class="fc" id="L72">    protected static final DateTimeParser MONTH_PARSER = DateTimeFormat.forPattern(&quot;yyyy-MM&quot;).getParser();</span>
<span class="fc" id="L73">    protected static final DateTimeParser DAY_PARSER = DateTimeFormat.forPattern(&quot;yyyy-MM-dd&quot;).getParser();</span>
    
<span class="fc" id="L75">    private static final DateTimeFormatter DAY_FORMATTER = new DateTimeFormatter(null, DAY_PARSER);</span>
<span class="fc" id="L76">    private static final DateTimeFormatter MONTH_FORMATTER = new DateTimeFormatter(null, MONTH_PARSER);</span>
<span class="fc" id="L77">    private static final DateTimeFormatter YEAR_FORMATTER = new DateTimeFormatter(null, YEAR_PARSER);</span>

<span class="fc" id="L79">    private static final DateTimeParser[] DATE_PARSERS = new DateTimeParser[]{</span>
            YEAR_PARSER,
            MONTH_PARSER,
            DAY_PARSER};
<span class="fc" id="L83">    private static final DateTimeFormatter DATE_FORMATTER = new DateTimeFormatterBuilder().append( null, DATE_PARSERS).toFormatter();</span>

    /**
     * Returns a document.
     *
     * @api {get} /document/:id Get a document
     * @apiName GetDocument
     * @apiGroup Document
     * @apiParam {String} id Document ID
     * @apiParam {String} share Share ID
     * @apiParam {Booleans} files If true includes files information
     * @apiSuccess {String} id ID
     * @apiSuccess {String} title Title
     * @apiSuccess {String} description Description
     * @apiSuccess {Number} create_date Create date (timestamp)
     * @apiSuccess {Number} update_date Update date (timestamp)
     * @apiSuccess {String} language Language
     * @apiSuccess {Boolean} shared True if the document is shared
     * @apiSuccess {Number} file_count Number of files in this document
     * @apiSuccess {Object[]} tags List of tags
     * @apiSuccess {String} tags.id ID
     * @apiSuccess {String} tags.name Name
     * @apiSuccess {String} tags.color Color
     * @apiSuccess {String} subject Subject
     * @apiSuccess {String} identifier Identifier
     * @apiSuccess {String} publisher Publisher
     * @apiSuccess {String} format Format
     * @apiSuccess {String} source Source
     * @apiSuccess {String} type Type
     * @apiSuccess {String} coverage Coverage
     * @apiSuccess {String} rights Rights
     * @apiSuccess {String} creator Username of the creator
     * @apiSuccess {Boolean} writable True if the document is writable by the current user
     * @apiSuccess {Object[]} acls List of ACL
     * @apiSuccess {String} acls.id ID
     * @apiSuccess {String=&quot;READ&quot;,&quot;WRITE&quot;} acls.perm Permission
     * @apiSuccess {String} acls.name Target name
     * @apiSuccess {String=&quot;USER&quot;,&quot;GROUP&quot;,&quot;SHARE&quot;} acls.type Target type
     * @apiSuccess {Object[]} inherited_acls List of ACL not directly applied to this document
     * @apiSuccess {String=&quot;READ&quot;,&quot;WRITE&quot;} inherited_acls.perm Permission
     * @apiSuccess {String} inherited_acls.source_id Source ID
     * @apiSuccess {String} inherited_acls.source_name Source name
     * @apiSuccess {String} inherited_acls.source_color The color of the Source
     * @apiSuccess {String} inherited_acls.id ID
     * @apiSuccess {String} inherited_acls.name Target name
     * @apiSuccess {String=&quot;USER&quot;,&quot;GROUP&quot;,&quot;SHARE&quot;} inherited_acls.type Target type
     * @apiSuccess {Object[]} contributors List of users having contributed to this document
     * @apiSuccess {String} contributors.username Username
     * @apiSuccess {String} contributors.email E-mail
     * @apiSuccess {Object[]} relations List of document related to this one
     * @apiSuccess {String} relations.id ID
     * @apiSuccess {String} relations.title Title
     * @apiSuccess {String} relations.source True if this document is the source of the relation
     * @apiSuccess {Object} route_step The current active route step
     * @apiSuccess {String} route_step.name Route step name
     * @apiSuccess {String=&quot;APPROVE&quot;, &quot;VALIDATE&quot;} route_step.type Route step type
     * @apiSuccess {Boolean} route_step.transitionable True if the route step is actionable by the current user
     * @apiSuccess {Object[]} files List of files
     * @apiSuccess {String} files.id ID
     * @apiSuccess {String} files.name File name
     * @apiSuccess {String} files.version Zero-based version number
     * @apiSuccess {String} files.mimetype MIME type
     * @apiSuccess {String} files.create_date Create date (timestamp)
     * @apiError (client) NotFound Document not found
     * @apiPermission none
     * @apiVersion 1.5.0
     *
     * @param documentId Document ID
     * @param shareId Share ID
     * @return Response
     */
    @GET
    @Path(&quot;{id: [a-z0-9\\-]+}&quot;)
    public Response get(
            @PathParam(&quot;id&quot;) String documentId,
            @QueryParam(&quot;share&quot;) String shareId,
            @QueryParam(&quot;files&quot;) Boolean files) {
<span class="fc" id="L160">        authenticate();</span>
        
<span class="fc" id="L162">        DocumentDao documentDao = new DocumentDao();</span>
<span class="fc" id="L163">        DocumentDto documentDto = documentDao.getDocument(documentId, PermType.READ, getTargetIdList(shareId));</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        if (documentDto == null) {</span>
<span class="fc" id="L165">            throw new NotFoundException();</span>
        }
            
<span class="fc" id="L168">        JsonObjectBuilder document = Json.createObjectBuilder()</span>
<span class="fc" id="L169">                .add(&quot;id&quot;, documentDto.getId())</span>
<span class="fc" id="L170">                .add(&quot;title&quot;, documentDto.getTitle())</span>
<span class="fc" id="L171">                .add(&quot;description&quot;, JsonUtil.nullable(documentDto.getDescription()))</span>
<span class="fc" id="L172">                .add(&quot;create_date&quot;, documentDto.getCreateTimestamp())</span>
<span class="fc" id="L173">                .add(&quot;update_date&quot;, documentDto.getUpdateTimestamp())</span>
<span class="fc" id="L174">                .add(&quot;language&quot;, documentDto.getLanguage())</span>
<span class="fc" id="L175">                .add(&quot;shared&quot;, documentDto.getShared())</span>
<span class="fc" id="L176">                .add(&quot;file_count&quot;, documentDto.getFileCount());</span>

<span class="fc" id="L178">        List&lt;TagDto&gt; tagDtoList = null;</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (principal.isAnonymous()) {</span>
            // No tags in anonymous mode (sharing)
<span class="nc" id="L181">            document.add(&quot;tags&quot;, Json.createArrayBuilder());</span>
        } else {
            // Add tags visible by the current user on this document
<span class="fc" id="L184">            TagDao tagDao = new TagDao();</span>
<span class="fc" id="L185">            tagDtoList = tagDao.findByCriteria(</span>
                    new TagCriteria()
<span class="fc" id="L187">                            .setTargetIdList(getTargetIdList(null)) // No tags for shares</span>
<span class="fc" id="L188">                            .setDocumentId(documentId),</span>
<span class="fc" id="L189">                    new SortCriteria(1, true));</span>
<span class="fc" id="L190">            JsonArrayBuilder tags = Json.createArrayBuilder();</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">            for (TagDto tagDto : tagDtoList) {</span>
<span class="fc" id="L192">                tags.add(Json.createObjectBuilder()</span>
<span class="fc" id="L193">                        .add(&quot;id&quot;, tagDto.getId())</span>
<span class="fc" id="L194">                        .add(&quot;name&quot;, tagDto.getName())</span>
<span class="fc" id="L195">                        .add(&quot;color&quot;, tagDto.getColor()));</span>
<span class="fc" id="L196">            }</span>
<span class="fc" id="L197">            document.add(&quot;tags&quot;, tags);</span>
        }
        
        // Below is specific to GET /document/id
<span class="fc" id="L201">        document.add(&quot;subject&quot;, JsonUtil.nullable(documentDto.getSubject()));</span>
<span class="fc" id="L202">        document.add(&quot;identifier&quot;, JsonUtil.nullable(documentDto.getIdentifier()));</span>
<span class="fc" id="L203">        document.add(&quot;publisher&quot;, JsonUtil.nullable(documentDto.getPublisher()));</span>
<span class="fc" id="L204">        document.add(&quot;format&quot;, JsonUtil.nullable(documentDto.getFormat()));</span>
<span class="fc" id="L205">        document.add(&quot;source&quot;, JsonUtil.nullable(documentDto.getSource()));</span>
<span class="fc" id="L206">        document.add(&quot;type&quot;, JsonUtil.nullable(documentDto.getType()));</span>
<span class="fc" id="L207">        document.add(&quot;coverage&quot;, JsonUtil.nullable(documentDto.getCoverage()));</span>
<span class="fc" id="L208">        document.add(&quot;rights&quot;, JsonUtil.nullable(documentDto.getRights()));</span>
<span class="fc" id="L209">        document.add(&quot;creator&quot;, documentDto.getCreator());</span>

        // Add ACL
<span class="fc" id="L212">        AclUtil.addAcls(document, documentId, getTargetIdList(shareId));</span>

        // Add computed ACL
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        if (tagDtoList != null) {</span>
<span class="fc" id="L216">            JsonArrayBuilder aclList = Json.createArrayBuilder();</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">            for (TagDto tagDto : tagDtoList) {</span>
<span class="fc" id="L218">                AclDao aclDao = new AclDao();</span>
<span class="fc" id="L219">                List&lt;AclDto&gt; aclDtoList = aclDao.getBySourceId(tagDto.getId(), AclType.USER);</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">                for (AclDto aclDto : aclDtoList) {</span>
<span class="fc" id="L221">                    aclList.add(Json.createObjectBuilder()</span>
<span class="fc" id="L222">                            .add(&quot;perm&quot;, aclDto.getPerm().name())</span>
<span class="fc" id="L223">                            .add(&quot;source_id&quot;, tagDto.getId())</span>
<span class="fc" id="L224">                            .add(&quot;source_name&quot;, tagDto.getName())</span>
<span class="fc" id="L225">                            .add(&quot;source_color&quot;, tagDto.getColor())</span>
<span class="fc" id="L226">                            .add(&quot;id&quot;, aclDto.getTargetId())</span>
<span class="fc" id="L227">                            .add(&quot;name&quot;, JsonUtil.nullable(aclDto.getTargetName()))</span>
<span class="fc" id="L228">                            .add(&quot;type&quot;, aclDto.getTargetType()));</span>
<span class="fc" id="L229">                }</span>
<span class="fc" id="L230">            }</span>
<span class="fc" id="L231">            document.add(&quot;inherited_acls&quot;, aclList);</span>
        }
        
        // Add contributors
<span class="fc" id="L235">        ContributorDao contributorDao = new ContributorDao();</span>
<span class="fc" id="L236">        List&lt;ContributorDto&gt; contributorDtoList = contributorDao.getByDocumentId(documentId);</span>
<span class="fc" id="L237">        JsonArrayBuilder contributorList = Json.createArrayBuilder();</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">        for (ContributorDto contributorDto : contributorDtoList) {</span>
<span class="fc" id="L239">            contributorList.add(Json.createObjectBuilder()</span>
<span class="fc" id="L240">                    .add(&quot;username&quot;, contributorDto.getUsername())</span>
<span class="fc" id="L241">                    .add(&quot;email&quot;, contributorDto.getEmail()));</span>
<span class="fc" id="L242">        }</span>
<span class="fc" id="L243">        document.add(&quot;contributors&quot;, contributorList);</span>
        
        // Add relations
<span class="fc" id="L246">        RelationDao relationDao = new RelationDao();</span>
<span class="fc" id="L247">        List&lt;RelationDto&gt; relationDtoList = relationDao.getByDocumentId(documentId);</span>
<span class="fc" id="L248">        JsonArrayBuilder relationList = Json.createArrayBuilder();</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        for (RelationDto relationDto : relationDtoList) {</span>
<span class="nc" id="L250">            relationList.add(Json.createObjectBuilder()</span>
<span class="nc" id="L251">                    .add(&quot;id&quot;, relationDto.getId())</span>
<span class="nc" id="L252">                    .add(&quot;title&quot;, relationDto.getTitle())</span>
<span class="nc" id="L253">                    .add(&quot;source&quot;, relationDto.isSource()));</span>
<span class="nc" id="L254">        }</span>
<span class="fc" id="L255">        document.add(&quot;relations&quot;, relationList);</span>

        // Add current route step
<span class="fc" id="L258">        RouteStepDto routeStepDto = new RouteStepDao().getCurrentStep(documentId);</span>
<span class="pc bpc" id="L259" title="3 of 4 branches missed.">        if (routeStepDto != null &amp;&amp; !principal.isAnonymous()) {</span>
<span class="nc" id="L260">            JsonObjectBuilder step = routeStepDto.toJson();</span>
<span class="nc" id="L261">            step.add(&quot;transitionable&quot;, getTargetIdList(null).contains(routeStepDto.getTargetId()));</span>
<span class="nc" id="L262">            document.add(&quot;route_step&quot;, step);</span>
        }

        // Add custom metadata
<span class="fc" id="L266">        MetadataUtil.addMetadata(document, documentId);</span>

        // Add files
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (Boolean.TRUE == files) {</span>
<span class="nc" id="L270">            FileDao fileDao = new FileDao();</span>
<span class="nc" id="L271">            List&lt;File&gt; fileList = fileDao.getByDocumentsIds(Collections.singleton(documentId));</span>

<span class="nc" id="L273">            JsonArrayBuilder filesArrayBuilder = Json.createArrayBuilder();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            for (File fileDb : fileList) {</span>
<span class="nc" id="L275">                filesArrayBuilder.add(RestUtil.fileToJsonObjectBuilder(fileDb));</span>
<span class="nc" id="L276">            }</span>

<span class="nc" id="L278">            document.add(&quot;files&quot;, filesArrayBuilder);</span>
        }

<span class="fc" id="L281">        return Response.ok().entity(document.build()).build();</span>
    }
    
    /**
     * Export a document to PDF.
     *
     * @api {get} /document/:id/pdf Export a document to PDF
     * @apiName GetDocumentPdf
     * @apiGroup Document
     * @apiParam {String} id Document ID
     * @apiParam {String} share Share ID
     * @apiParam {Boolean} metadata If true, export metadata
     * @apiParam {Boolean} comments If true, export comments
     * @apiParam {Boolean} fitimagetopage If true, fit the images to pages
     * @apiParam {Number} margin Margin around the pages, in millimeter
     * @apiSuccess {String} pdf The whole response is the PDF file
     * @apiError (client) NotFound Document not found
     * @apiError (client) ValidationError Validation error
     * @apiPermission none
     * @apiVersion 1.5.0
     *
     * @param documentId Document ID
     * @param shareId Share ID
     * @param metadata Export metadata
     * @param comments Export comments
     * @param fitImageToPage Fit images to page
     * @param marginStr Margins
     * @return Response
     */
    @GET
    @Path(&quot;{id: [a-z0-9\\-]+}/pdf&quot;)
    public Response getPdf(
            @PathParam(&quot;id&quot;) String documentId,
            @QueryParam(&quot;share&quot;) String shareId,
            final @QueryParam(&quot;metadata&quot;) Boolean metadata,
            final @QueryParam(&quot;comments&quot;) Boolean comments,
            final @QueryParam(&quot;fitimagetopage&quot;) Boolean fitImageToPage,
            @QueryParam(&quot;margin&quot;) String marginStr) {
<span class="nc" id="L319">        authenticate();</span>
        
        // Validate input
<span class="nc" id="L322">        final int margin = ValidationUtil.validateInteger(marginStr, &quot;margin&quot;);</span>
        
        // Get document and check read permission
<span class="nc" id="L325">        DocumentDao documentDao = new DocumentDao();</span>
<span class="nc" id="L326">        final DocumentDto documentDto = documentDao.getDocument(documentId, PermType.READ, getTargetIdList(shareId));</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (documentDto == null) {</span>
<span class="nc" id="L328">            throw new NotFoundException();</span>
        }
        
        // Get files
<span class="nc" id="L332">        FileDao fileDao = new FileDao();</span>
<span class="nc" id="L333">        UserDao userDao = new UserDao();</span>
<span class="nc" id="L334">        final List&lt;File&gt; fileList = fileDao.getByDocumentId(null, documentId);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        for (File file : fileList) {</span>
            // A file is always encrypted by the creator of it
            // Store its private key to decrypt it
<span class="nc" id="L338">            User user = userDao.getById(file.getUserId());</span>
<span class="nc" id="L339">            file.setPrivateKey(user.getPrivateKey());</span>
<span class="nc" id="L340">        }</span>
        
        // Convert to PDF
<span class="nc" id="L343">        StreamingOutput stream = outputStream -&gt; {</span>
            try {
<span class="nc" id="L345">                PdfUtil.convertToPdf(documentDto, fileList, fitImageToPage, metadata, margin, outputStream);</span>
<span class="nc" id="L346">            } catch (Exception e) {</span>
<span class="nc" id="L347">                throw new IOException(e);</span>
<span class="nc" id="L348">            }</span>
<span class="nc" id="L349">        };</span>

<span class="nc" id="L351">        return Response.ok(stream)</span>
<span class="nc" id="L352">                .header(&quot;Content-Type&quot;, MimeType.APPLICATION_PDF)</span>
<span class="nc" id="L353">                .header(&quot;Content-Disposition&quot;, &quot;inline; filename=\&quot;&quot; + documentDto.getTitle() + &quot;.pdf\&quot;&quot;)</span>
<span class="nc" id="L354">                .build();</span>
    }
    
    /**
     * Returns all documents.
     *
     * @api {get} /document/list Get documents
     * @apiName GetDocumentList
     * @apiGroup Document
     * @apiParam {String} limit Total number of documents to return
     * @apiParam {String} offset Start at this index
     * @apiParam {Number} sort_column Column index to sort on
     * @apiParam {Boolean} asc If true, sort in ascending order
     * @apiParam {String} search Search query (see &quot;Document search syntax&quot; on the top of the page for explanations)
     * @apiParam {Booleans} files If true includes files information
     * @apiSuccess {Number} total Total number of documents
     * @apiSuccess {Object[]} documents List of documents
     * @apiSuccess {String} documents.id ID
     * @apiSuccess {String} documents.highlight Search highlight (for fulltext search)
     * @apiSuccess {String} documents.file_id Main file ID
     * @apiSuccess {String} documents.title Title
     * @apiSuccess {String} documents.description Description
     * @apiSuccess {Number} documents.create_date Create date (timestamp)
     * @apiSuccess {Number} documents.update_date Update date (timestamp)
     * @apiSuccess {String} documents.language Language
     * @apiSuccess {Boolean} documents.shared True if the document is shared
     * @apiSuccess {Boolean} documents.active_route True if a route is active on this document
     * @apiSuccess {Boolean} documents.current_step_name Name of the current route step
     * @apiSuccess {Number} documents.file_count Number of files in this document
     * @apiSuccess {Object[]} documents.tags List of tags
     * @apiSuccess {String} documents.tags.id ID
     * @apiSuccess {String} documents.tags.name Name
     * @apiSuccess {String} documents.tags.color Color
     * @apiSuccess {Object[]} documents.files List of files
     * @apiSuccess {String} documents.files.id ID
     * @apiSuccess {String} documents.files.name File name
     * @apiSuccess {String} documents.files.version Zero-based version number
     * @apiSuccess {String} documents.files.mimetype MIME type
     * @apiSuccess {String} documents.files.create_date Create date (timestamp)
     * @apiSuccess {String[]} suggestions List of search suggestions
     * @apiError (client) ForbiddenError Access denied
     * @apiError (server) SearchError Error searching in documents
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @param limit Page limit
     * @param offset Page offset
     * @param sortColumn Sort column
     * @param asc Sorting
     * @param search Search query
     * @param files Files list
     * @return Response
     */
    @GET
    @Path(&quot;list&quot;)
    public Response list(
            @QueryParam(&quot;limit&quot;) Integer limit,
            @QueryParam(&quot;offset&quot;) Integer offset,
            @QueryParam(&quot;sort_column&quot;) Integer sortColumn,
            @QueryParam(&quot;asc&quot;) Boolean asc,
            @QueryParam(&quot;search&quot;) String search,
            @QueryParam(&quot;files&quot;) Boolean files) {
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L417">            throw new ForbiddenClientException();</span>
        }
        
<span class="fc" id="L420">        JsonObjectBuilder response = Json.createObjectBuilder();</span>
<span class="fc" id="L421">        JsonArrayBuilder documents = Json.createArrayBuilder();</span>
        
<span class="fc" id="L423">        TagDao tagDao = new TagDao();</span>
<span class="fc" id="L424">        PaginatedList&lt;DocumentDto&gt; paginatedList = PaginatedLists.create(limit, offset);</span>
<span class="fc" id="L425">        List&lt;String&gt; suggestionList = Lists.newArrayList();</span>
<span class="fc" id="L426">        SortCriteria sortCriteria = new SortCriteria(sortColumn, asc);</span>
<span class="fc" id="L427">        DocumentCriteria documentCriteria = parseSearchQuery(search);</span>
<span class="fc" id="L428">        documentCriteria.setTargetIdList(getTargetIdList(null));</span>
        try {
<span class="fc" id="L430">            AppContext.getInstance().getIndexingHandler().findByCriteria(paginatedList, suggestionList, documentCriteria, sortCriteria);</span>
<span class="nc" id="L431">        } catch (Exception e) {</span>
<span class="nc" id="L432">            throw new ServerException(&quot;SearchError&quot;, &quot;Error searching in documents&quot;, e);</span>
<span class="fc" id="L433">        }</span>

        // Find the files of the documents
<span class="fc" id="L436">        List&lt;File&gt; filesList = null;</span>
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">        if (Boolean.TRUE == files) {</span>
<span class="nc" id="L438">            Iterable&lt;String&gt; documentsIds = CollectionUtils.collect(paginatedList.getResultList(), DocumentDto::getId);</span>
<span class="nc" id="L439">            FileDao fileDao = new FileDao();</span>
<span class="nc" id="L440">            filesList = fileDao.getByDocumentsIds(documentsIds);</span>
        }

<span class="fc bfc" id="L443" title="All 2 branches covered.">        for (DocumentDto documentDto : paginatedList.getResultList()) {</span>
            // Get tags accessible by the current user on this document
<span class="fc" id="L445">            List&lt;TagDto&gt; tagDtoList = tagDao.findByCriteria(new TagCriteria()</span>
<span class="fc" id="L446">                    .setTargetIdList(getTargetIdList(null))</span>
<span class="fc" id="L447">                    .setDocumentId(documentDto.getId()), new SortCriteria(1, true));</span>
<span class="fc" id="L448">            JsonArrayBuilder tags = Json.createArrayBuilder();</span>
<span class="fc bfc" id="L449" title="All 2 branches covered.">            for (TagDto tagDto : tagDtoList) {</span>
<span class="fc" id="L450">                tags.add(Json.createObjectBuilder()</span>
<span class="fc" id="L451">                        .add(&quot;id&quot;, tagDto.getId())</span>
<span class="fc" id="L452">                        .add(&quot;name&quot;, tagDto.getName())</span>
<span class="fc" id="L453">                        .add(&quot;color&quot;, tagDto.getColor()));</span>
<span class="fc" id="L454">            }</span>

<span class="fc" id="L456">            JsonObjectBuilder documentObjectBuilder = Json.createObjectBuilder()</span>
<span class="fc" id="L457">                    .add(&quot;id&quot;, documentDto.getId())</span>
<span class="fc" id="L458">                    .add(&quot;highlight&quot;, JsonUtil.nullable(documentDto.getHighlight()))</span>
<span class="fc" id="L459">                    .add(&quot;file_id&quot;, JsonUtil.nullable(documentDto.getFileId()))</span>
<span class="fc" id="L460">                    .add(&quot;title&quot;, documentDto.getTitle())</span>
<span class="fc" id="L461">                    .add(&quot;description&quot;, JsonUtil.nullable(documentDto.getDescription()))</span>
<span class="fc" id="L462">                    .add(&quot;create_date&quot;, documentDto.getCreateTimestamp())</span>
<span class="fc" id="L463">                    .add(&quot;update_date&quot;, documentDto.getUpdateTimestamp())</span>
<span class="fc" id="L464">                    .add(&quot;language&quot;, documentDto.getLanguage())</span>
<span class="fc" id="L465">                    .add(&quot;shared&quot;, documentDto.getShared())</span>
<span class="fc" id="L466">                    .add(&quot;active_route&quot;, documentDto.isActiveRoute())</span>
<span class="fc" id="L467">                    .add(&quot;current_step_name&quot;, JsonUtil.nullable(documentDto.getCurrentStepName()))</span>
<span class="fc" id="L468">                    .add(&quot;file_count&quot;, documentDto.getFileCount())</span>
<span class="fc" id="L469">                    .add(&quot;tags&quot;, tags);</span>
<span class="pc bpc" id="L470" title="1 of 2 branches missed.">            if (Boolean.TRUE == files) {</span>
<span class="nc" id="L471">                JsonArrayBuilder filesArrayBuilder = Json.createArrayBuilder();</span>
                // Find files matching the document
<span class="nc" id="L473">                Collection&lt;File&gt; filesOfDocument = CollectionUtils.select(filesList, file -&gt; file.getDocumentId().equals(documentDto.getId()));</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">                for (File fileDb : filesOfDocument) {</span>
<span class="nc" id="L475">                    filesArrayBuilder.add(RestUtil.fileToJsonObjectBuilder(fileDb));</span>
<span class="nc" id="L476">                }</span>
<span class="nc" id="L477">                documentObjectBuilder.add(&quot;files&quot;, filesArrayBuilder);</span>
            }
<span class="fc" id="L479">            documents.add(documentObjectBuilder);</span>
<span class="fc" id="L480">        }</span>

<span class="fc" id="L482">        JsonArrayBuilder suggestions = Json.createArrayBuilder();</span>
<span class="pc bpc" id="L483" title="1 of 2 branches missed.">        for (String suggestion : suggestionList) {</span>
<span class="nc" id="L484">            suggestions.add(suggestion);</span>
<span class="nc" id="L485">        }</span>

<span class="fc" id="L487">        response.add(&quot;total&quot;, paginatedList.getResultCount())</span>
<span class="fc" id="L488">                .add(&quot;documents&quot;, documents)</span>
<span class="fc" id="L489">                .add(&quot;suggestions&quot;, suggestions);</span>
        
<span class="fc" id="L491">        return Response.ok().entity(response.build()).build();</span>
    }
    
    /**
     * Parse a query according to the specified syntax, eg.:
     * tag:assurance tag:other before:2012 after:2011-09 shared:yes lang:fra thing
     *
     * @param search Search query
     * @return DocumentCriteria
     */
    private DocumentCriteria parseSearchQuery(String search) {
<span class="fc" id="L502">        DocumentCriteria documentCriteria = new DocumentCriteria();</span>
<span class="fc bfc" id="L503" title="All 2 branches covered.">        if (Strings.isNullOrEmpty(search)) {</span>
<span class="fc" id="L504">            return documentCriteria;</span>
        }

<span class="fc" id="L507">        TagDao tagDao = new TagDao();</span>
<span class="fc" id="L508">        List&lt;TagDto&gt; allTagDtoList = tagDao.findByCriteria(new TagCriteria().setTargetIdList(getTargetIdList(null)), null);</span>
<span class="fc" id="L509">        UserDao userDao = new UserDao();</span>

<span class="fc" id="L511">        String[] criteriaList = search.split(&quot; +&quot;);</span>
<span class="fc" id="L512">        List&lt;String&gt; query = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L513">        List&lt;String&gt; fullQuery = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L514" title="All 2 branches covered.">        for (String criteria : criteriaList) {</span>
<span class="fc" id="L515">            String[] params = criteria.split(&quot;:&quot;);</span>
<span class="pc bpc" id="L516" title="3 of 6 branches missed.">            if (params.length != 2 || Strings.isNullOrEmpty(params[0]) || Strings.isNullOrEmpty(params[1])) {</span>
                // This is not a special criteria, do a fulltext search on it
<span class="nc" id="L518">                fullQuery.add(criteria);</span>
<span class="nc" id="L519">                continue;</span>
            }
<span class="fc" id="L521">            String paramName = params[0];</span>
<span class="fc" id="L522">            String paramValue = params[1];</span>

<span class="pc bpc" id="L524" title="10 of 12 branches missed.">            switch (paramName) {</span>
                case &quot;tag&quot;:
                case &quot;!tag&quot;:
                    // New tag criteria
<span class="fc" id="L528">                    List&lt;TagDto&gt; tagDtoList = TagUtil.findByName(paramValue, allTagDtoList);</span>
<span class="pc bpc" id="L529" title="1 of 2 branches missed.">                    if (tagDtoList.isEmpty()) {</span>
                        // No tag found, the request must return nothing
<span class="nc" id="L531">                        documentCriteria.getTagIdList().add(Lists.newArrayList(UUID.randomUUID().toString()));</span>
                    } else {
<span class="fc" id="L533">                        List&lt;String&gt; tagIdList = Lists.newArrayList();</span>
<span class="fc bfc" id="L534" title="All 2 branches covered.">                        for (TagDto tagDto : tagDtoList) {</span>
<span class="fc" id="L535">                            tagIdList.add(tagDto.getId());</span>
<span class="fc" id="L536">                            List&lt;TagDto&gt; childrenTagDtoList = TagUtil.findChildren(tagDto, allTagDtoList);</span>
<span class="pc bpc" id="L537" title="1 of 2 branches missed.">                            for (TagDto childrenTagDto : childrenTagDtoList) {</span>
<span class="nc" id="L538">                                tagIdList.add(childrenTagDto.getId());</span>
<span class="nc" id="L539">                            }</span>
<span class="fc" id="L540">                        }</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">                        if (paramName.startsWith(&quot;!&quot;)) {</span>
<span class="nc" id="L542">                            documentCriteria.getExcludedTagIdList().add(tagIdList);</span>
                        } else {
<span class="fc" id="L544">                            documentCriteria.getTagIdList().add(tagIdList);</span>
                        }
                    }
<span class="fc" id="L547">                    break;</span>
                case &quot;after&quot;:
                case &quot;before&quot;:
                case &quot;uafter&quot;:
                case &quot;ubefore&quot;:
                    // New date span criteria
                    try {
<span class="nc" id="L554">                        boolean isUpdated = paramName.startsWith(&quot;u&quot;);</span>
<span class="nc" id="L555">                        DateTime date = DATE_FORMATTER.parseDateTime(paramValue);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">                        if (paramName.endsWith(&quot;before&quot;)) {</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">                            if (isUpdated) documentCriteria.setUpdateDateMax(date.toDate());</span>
<span class="nc" id="L558">                            else documentCriteria.setCreateDateMax(date.toDate());</span>
                        } else {
<span class="nc bnc" id="L560" title="All 2 branches missed.">                            if (isUpdated) documentCriteria.setUpdateDateMin(date.toDate());</span>
<span class="nc" id="L561">                            else  documentCriteria.setCreateDateMin(date.toDate());</span>
                        }
<span class="nc" id="L563">                    } catch (IllegalArgumentException e) {</span>
                        // Invalid date, returns no documents
<span class="nc" id="L565">                        documentCriteria.setCreateDateMin(new Date(0));</span>
<span class="nc" id="L566">                        documentCriteria.setCreateDateMax(new Date(0));</span>
<span class="nc" id="L567">                    }</span>
<span class="nc" id="L568">                    break;</span>
                case &quot;uat&quot;:
                case &quot;at&quot;:
                    // New specific date criteria
<span class="nc" id="L572">                    boolean isUpdated = params[0].startsWith(&quot;u&quot;);</span>
                    try {
<span class="nc bnc" id="L574" title="All 4 branches missed.">                        switch (paramValue.length()) {</span>
                            case 10: {
<span class="nc" id="L576">                                DateTime date = DATE_FORMATTER.parseDateTime(params[1]);</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">                                if (isUpdated) {</span>
<span class="nc" id="L578">                                    documentCriteria.setUpdateDateMin(date.toDate());</span>
<span class="nc" id="L579">                                    documentCriteria.setUpdateDateMax(date.plusDays(1).minusSeconds(1).toDate());</span>
                                } else {
<span class="nc" id="L581">                                    documentCriteria.setCreateDateMin(date.toDate());</span>
<span class="nc" id="L582">                                    documentCriteria.setCreateDateMax(date.plusDays(1).minusSeconds(1).toDate());</span>
                                }
<span class="nc" id="L584">                                break;</span>
                            }
                            case 7: {
<span class="nc" id="L587">                                DateTime date = MONTH_FORMATTER.parseDateTime(params[1]);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">                                if (isUpdated) {</span>
<span class="nc" id="L589">                                    documentCriteria.setUpdateDateMin(date.toDate());</span>
<span class="nc" id="L590">                                    documentCriteria.setUpdateDateMax(date.plusMonths(1).minusSeconds(1).toDate());</span>
                                } else {
<span class="nc" id="L592">                                    documentCriteria.setCreateDateMin(date.toDate());</span>
<span class="nc" id="L593">                                    documentCriteria.setCreateDateMax(date.plusMonths(1).minusSeconds(1).toDate());</span>
                                }
<span class="nc" id="L595">                                break;</span>
                            }
                            case 4: {
<span class="nc" id="L598">                                DateTime date = YEAR_FORMATTER.parseDateTime(params[1]);</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                                if (isUpdated) {</span>
<span class="nc" id="L600">                                    documentCriteria.setUpdateDateMin(date.toDate());</span>
<span class="nc" id="L601">                                    documentCriteria.setUpdateDateMax(date.plusYears(1).minusSeconds(1).toDate());</span>
                                } else {
<span class="nc" id="L603">                                    documentCriteria.setCreateDateMin(date.toDate());</span>
<span class="nc" id="L604">                                    documentCriteria.setCreateDateMax(date.plusYears(1).minusSeconds(1).toDate());</span>
                                }
<span class="nc" id="L606">                                break;</span>
                            } default: {
                                // Invalid format, returns no documents
<span class="nc" id="L609">                                documentCriteria.setCreateDateMin(new Date(0));</span>
<span class="nc" id="L610">                                documentCriteria.setCreateDateMax(new Date(0));</span>
                            }
                        }
<span class="nc" id="L613">                    } catch (IllegalArgumentException e) {</span>
                        // Invalid date, returns no documents
<span class="nc" id="L615">                        documentCriteria.setCreateDateMin(new Date(0));</span>
<span class="nc" id="L616">                        documentCriteria.setCreateDateMax(new Date(0));</span>
<span class="nc" id="L617">                    }</span>
<span class="nc" id="L618">                    break;</span>
                case &quot;shared&quot;:
                    // New shared state criteria
<span class="nc" id="L621">                    documentCriteria.setShared(paramValue.equals(&quot;yes&quot;));</span>
<span class="nc" id="L622">                    break;</span>
                case &quot;lang&quot;:
                    // New language criteria
<span class="nc bnc" id="L625" title="All 2 branches missed.">                    if (Constants.SUPPORTED_LANGUAGES.contains(paramValue)) {</span>
<span class="nc" id="L626">                        documentCriteria.setLanguage(paramValue);</span>
                    } else {
                        // Unsupported language, returns no documents
<span class="nc" id="L629">                        documentCriteria.setLanguage(UUID.randomUUID().toString());</span>
                    }
<span class="nc" id="L631">                    break;</span>
                case &quot;mime&quot;:
                    // New mime type criteria
<span class="nc" id="L634">                    documentCriteria.setMimeType(paramValue);</span>
<span class="nc" id="L635">                    break;</span>
                case &quot;by&quot;:
                    // New creator criteria
<span class="nc" id="L638">                    User user = userDao.getActiveByUsername(paramValue);</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                    if (user == null) {</span>
                        // This user doesn't exist, return nothing
<span class="nc" id="L641">                        documentCriteria.setCreatorId(UUID.randomUUID().toString());</span>
                    } else {
                        // This user exists, search its documents
<span class="nc" id="L644">                        documentCriteria.setCreatorId(user.getId());</span>
                    }
<span class="nc" id="L646">                    break;</span>
                case &quot;workflow&quot;:
                    // New shared state criteria
<span class="nc" id="L649">                    documentCriteria.setActiveRoute(paramValue.equals(&quot;me&quot;));</span>
<span class="nc" id="L650">                    break;</span>
                case &quot;simple&quot;:
                    // New simple search criteria
<span class="nc" id="L653">                    query.add(paramValue);</span>
<span class="nc" id="L654">                    break;</span>
                case &quot;full&quot;:
                    // New fulltext search criteria
<span class="fc" id="L657">                    fullQuery.add(paramValue);</span>
<span class="fc" id="L658">                    break;</span>
                case &quot;title&quot;:
                    // New title criteria
<span class="nc" id="L661">                    documentCriteria.setTitle(paramValue);</span>
<span class="nc" id="L662">                    break;</span>
                default:
<span class="nc" id="L664">                    fullQuery.add(criteria);</span>
                    break;
            }
        }

<span class="fc" id="L669">        documentCriteria.setSearch(Joiner.on(&quot; &quot;).join(query));</span>
<span class="fc" id="L670">        documentCriteria.setFullSearch(Joiner.on(&quot; &quot;).join(fullQuery));</span>
<span class="fc" id="L671">        return documentCriteria;</span>
    }

    /**
     * Creates a new document.
     *
     * @api {put} /document Add a document
     * @apiName PutDocument
     * @apiGroup Document
     * @apiParam {String} title Title
     * @apiParam {String} [description] Description
     * @apiParam {String} [subject] Subject
     * @apiParam {String} [identifier] Identifier
     * @apiParam {String} [publisher] Publisher
     * @apiParam {String} [format] Format
     * @apiParam {String} [source] Source
     * @apiParam {String} [type] Type
     * @apiParam {String} [coverage] Coverage
     * @apiParam {String} [rights] Rights
     * @apiParam {String[]} [tags] List of tags ID
     * @apiParam {String[]} [relations] List of related documents ID
     * @apiParam {String[]} [metadata_id] List of metadata ID
     * @apiParam {String[]} [metadata_value] List of metadata values
     * @apiParam {String} language Language
     * @apiParam {Number} [create_date] Create date (timestamp)
     * @apiSuccess {String} id Document ID
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @param title Title
     * @param description Description
     * @param subject Subject
     * @param identifier Identifier
     * @param publisher Publisher
     * @param format Format
     * @param source Source
     * @param type Type
     * @param coverage Coverage
     * @param rights Rights
     * @param tagList Tags
     * @param relationList Relations
     * @param metadataIdList Metadata ID list
     * @param metadataValueList Metadata value list
     * @param language Language
     * @param createDateStr Creation date
     * @return Response
     */
    @PUT
    public Response add(
            @FormParam(&quot;title&quot;) String title,
            @FormParam(&quot;description&quot;) String description,
            @FormParam(&quot;subject&quot;) String subject,
            @FormParam(&quot;identifier&quot;) String identifier,
            @FormParam(&quot;publisher&quot;) String publisher,
            @FormParam(&quot;format&quot;) String format,
            @FormParam(&quot;source&quot;) String source,
            @FormParam(&quot;type&quot;) String type,
            @FormParam(&quot;coverage&quot;) String coverage,
            @FormParam(&quot;rights&quot;) String rights,
            @FormParam(&quot;tags&quot;) List&lt;String&gt; tagList,
            @FormParam(&quot;relations&quot;) List&lt;String&gt; relationList,
            @FormParam(&quot;metadata_id&quot;) List&lt;String&gt; metadataIdList,
            @FormParam(&quot;metadata_value&quot;) List&lt;String&gt; metadataValueList,
            @FormParam(&quot;language&quot;) String language,
            @FormParam(&quot;create_date&quot;) String createDateStr) {
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L739">            throw new ForbiddenClientException();</span>
        }
        
        // Validate input data
<span class="fc" id="L743">        title = ValidationUtil.validateLength(title, &quot;title&quot;, 1, 100, false);</span>
<span class="fc" id="L744">        language = ValidationUtil.validateLength(language, &quot;language&quot;, 3, 7, false);</span>
<span class="fc" id="L745">        description = ValidationUtil.validateLength(description, &quot;description&quot;, 0, 4000, true);</span>
<span class="fc" id="L746">        subject = ValidationUtil.validateLength(subject, &quot;subject&quot;, 0, 500, true);</span>
<span class="fc" id="L747">        identifier = ValidationUtil.validateLength(identifier, &quot;identifier&quot;, 0, 500, true);</span>
<span class="fc" id="L748">        publisher = ValidationUtil.validateLength(publisher, &quot;publisher&quot;, 0, 500, true);</span>
<span class="fc" id="L749">        format = ValidationUtil.validateLength(format, &quot;format&quot;, 0, 500, true);</span>
<span class="fc" id="L750">        source = ValidationUtil.validateLength(source, &quot;source&quot;, 0, 500, true);</span>
<span class="fc" id="L751">        type = ValidationUtil.validateLength(type, &quot;type&quot;, 0, 100, true);</span>
<span class="fc" id="L752">        coverage = ValidationUtil.validateLength(coverage, &quot;coverage&quot;, 0, 100, true);</span>
<span class="fc" id="L753">        rights = ValidationUtil.validateLength(rights, &quot;rights&quot;, 0, 100, true);</span>
<span class="fc" id="L754">        Date createDate = ValidationUtil.validateDate(createDateStr, &quot;create_date&quot;, true);</span>
<span class="pc bpc" id="L755" title="1 of 2 branches missed.">        if (!Constants.SUPPORTED_LANGUAGES.contains(language)) {</span>
<span class="nc" id="L756">            throw new ClientException(&quot;ValidationError&quot;, MessageFormat.format(&quot;{0} is not a supported language&quot;, language));</span>
        }

        // Create the document
<span class="fc" id="L760">        Document document = new Document();</span>
<span class="fc" id="L761">        document.setUserId(principal.getId());</span>
<span class="fc" id="L762">        document.setTitle(title);</span>
<span class="fc" id="L763">        document.setDescription(description);</span>
<span class="fc" id="L764">        document.setSubject(subject);</span>
<span class="fc" id="L765">        document.setIdentifier(identifier);</span>
<span class="fc" id="L766">        document.setPublisher(publisher);</span>
<span class="fc" id="L767">        document.setFormat(format);</span>
<span class="fc" id="L768">        document.setSource(source);</span>
<span class="fc" id="L769">        document.setType(type);</span>
<span class="fc" id="L770">        document.setCoverage(coverage);</span>
<span class="fc" id="L771">        document.setRights(rights);</span>
<span class="fc" id="L772">        document.setLanguage(language);</span>
<span class="fc bfc" id="L773" title="All 2 branches covered.">        if (createDate == null) {</span>
<span class="fc" id="L774">            document.setCreateDate(new Date());</span>
        } else {
<span class="fc" id="L776">            document.setCreateDate(createDate);</span>
        }

        // Save the document, create the base ACLs
<span class="fc" id="L780">        document = DocumentUtil.createDocument(document, principal.getId());</span>

        // Update tags
<span class="fc" id="L783">        updateTagList(document.getId(), tagList);</span>

        // Update relations
<span class="fc" id="L786">        updateRelationList(document.getId(), relationList);</span>

        // Update custom metadata
        try {
<span class="fc" id="L790">            MetadataUtil.updateMetadata(document.getId(), metadataIdList, metadataValueList);</span>
<span class="nc" id="L791">        } catch (Exception e) {</span>
<span class="nc" id="L792">            throw new ClientException(&quot;ValidationError&quot;, e.getMessage());</span>
<span class="fc" id="L793">        }</span>

        // Raise a document created event
<span class="fc" id="L796">        DocumentCreatedAsyncEvent documentCreatedAsyncEvent = new DocumentCreatedAsyncEvent();</span>
<span class="fc" id="L797">        documentCreatedAsyncEvent.setUserId(principal.getId());</span>
<span class="fc" id="L798">        documentCreatedAsyncEvent.setDocumentId(document.getId());</span>
<span class="fc" id="L799">        ThreadLocalContext.get().addAsyncEvent(documentCreatedAsyncEvent);</span>

<span class="fc" id="L801">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="fc" id="L802">                .add(&quot;id&quot;, document.getId());</span>
<span class="fc" id="L803">        return Response.ok().entity(response.build()).build();</span>
    }
    
    /**
     * Updates the document.
     *
     * @api {post} /document/:id Update a document
     * @apiName PostDocument
     * @apiGroup Document
     * @apiParam {String} id ID
     * @apiParam {String} title Title
     * @apiParam {String} [description] Description
     * @apiParam {String} [subject] Subject
     * @apiParam {String} [identifier] Identifier
     * @apiParam {String} [publisher] Publisher
     * @apiParam {String} [format] Format
     * @apiParam {String} [source] Source
     * @apiParam {String} [type] Type
     * @apiParam {String} [coverage] Coverage
     * @apiParam {String} [rights] Rights
     * @apiParam {String[]} [tags] List of tags ID
     * @apiParam {String[]} [relations] List of related documents ID
     * @apiParam {String[]} [metadata_id] List of metadata ID
     * @apiParam {String[]} [metadata_value] List of metadata values
     * @apiParam {String} language Language
     * @apiParam {Number} [create_date] Create date (timestamp)
     * @apiSuccess {String} id Document ID
     * @apiError (client) ForbiddenError Access denied or document not writable
     * @apiError (client) ValidationError Validation error
     * @apiError (client) NotFound Document not found
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @param title Title
     * @param description Description
     * @return Response
     */
    @POST
    @Path(&quot;{id: [a-z0-9\\-]+}&quot;)
    public Response update(
            @PathParam(&quot;id&quot;) String id,
            @FormParam(&quot;title&quot;) String title,
            @FormParam(&quot;description&quot;) String description,
            @FormParam(&quot;subject&quot;) String subject,
            @FormParam(&quot;identifier&quot;) String identifier,
            @FormParam(&quot;publisher&quot;) String publisher,
            @FormParam(&quot;format&quot;) String format,
            @FormParam(&quot;source&quot;) String source,
            @FormParam(&quot;type&quot;) String type,
            @FormParam(&quot;coverage&quot;) String coverage,
            @FormParam(&quot;rights&quot;) String rights,
            @FormParam(&quot;tags&quot;) List&lt;String&gt; tagList,
            @FormParam(&quot;relations&quot;) List&lt;String&gt; relationList,
            @FormParam(&quot;metadata_id&quot;) List&lt;String&gt; metadataIdList,
            @FormParam(&quot;metadata_value&quot;) List&lt;String&gt; metadataValueList,
            @FormParam(&quot;language&quot;) String language,
            @FormParam(&quot;create_date&quot;) String createDateStr) {
<span class="pc bpc" id="L860" title="1 of 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L861">            throw new ForbiddenClientException();</span>
        }
        
        // Validate input data
<span class="fc" id="L865">        title = ValidationUtil.validateLength(title, &quot;title&quot;, 1, 100, false);</span>
<span class="fc" id="L866">        language = ValidationUtil.validateLength(language, &quot;language&quot;, 3, 7, false);</span>
<span class="fc" id="L867">        description = ValidationUtil.validateLength(description, &quot;description&quot;, 0, 4000, true);</span>
<span class="fc" id="L868">        subject = ValidationUtil.validateLength(subject, &quot;subject&quot;, 0, 500, true);</span>
<span class="fc" id="L869">        identifier = ValidationUtil.validateLength(identifier, &quot;identifier&quot;, 0, 500, true);</span>
<span class="fc" id="L870">        publisher = ValidationUtil.validateLength(publisher, &quot;publisher&quot;, 0, 500, true);</span>
<span class="fc" id="L871">        format = ValidationUtil.validateLength(format, &quot;format&quot;, 0, 500, true);</span>
<span class="fc" id="L872">        source = ValidationUtil.validateLength(source, &quot;source&quot;, 0, 500, true);</span>
<span class="fc" id="L873">        type = ValidationUtil.validateLength(type, &quot;type&quot;, 0, 100, true);</span>
<span class="fc" id="L874">        coverage = ValidationUtil.validateLength(coverage, &quot;coverage&quot;, 0, 100, true);</span>
<span class="fc" id="L875">        rights = ValidationUtil.validateLength(rights, &quot;rights&quot;, 0, 100, true);</span>
<span class="fc" id="L876">        Date createDate = ValidationUtil.validateDate(createDateStr, &quot;create_date&quot;, true);</span>
<span class="pc bpc" id="L877" title="2 of 4 branches missed.">        if (language != null &amp;&amp; !Constants.SUPPORTED_LANGUAGES.contains(language)) {</span>
<span class="nc" id="L878">            throw new ClientException(&quot;ValidationError&quot;, MessageFormat.format(&quot;{0} is not a supported language&quot;, language));</span>
        }
        
        // Check write permission
<span class="fc" id="L882">        AclDao aclDao = new AclDao();</span>
<span class="fc bfc" id="L883" title="All 2 branches covered.">        if (!aclDao.checkPermission(id, PermType.WRITE, getTargetIdList(null))) {</span>
<span class="fc" id="L884">            throw new ForbiddenClientException();</span>
        }
        
        // Get the document
<span class="fc" id="L888">        DocumentDao documentDao = new DocumentDao();</span>
<span class="fc" id="L889">        Document document = documentDao.getById(id);</span>
<span class="pc bpc" id="L890" title="1 of 2 branches missed.">        if (document == null) {</span>
<span class="nc" id="L891">            throw new NotFoundException();</span>
        }
        
        // Update the document
<span class="fc" id="L895">        document.setTitle(title);</span>
<span class="fc" id="L896">        document.setDescription(description);</span>
<span class="fc" id="L897">        document.setSubject(subject);</span>
<span class="fc" id="L898">        document.setIdentifier(identifier);</span>
<span class="fc" id="L899">        document.setPublisher(publisher);</span>
<span class="fc" id="L900">        document.setFormat(format);</span>
<span class="fc" id="L901">        document.setSource(source);</span>
<span class="fc" id="L902">        document.setType(type);</span>
<span class="fc" id="L903">        document.setCoverage(coverage);</span>
<span class="fc" id="L904">        document.setRights(rights);</span>
<span class="fc" id="L905">        document.setLanguage(language);</span>
<span class="pc bpc" id="L906" title="1 of 2 branches missed.">        if (createDate == null) {</span>
<span class="fc" id="L907">            document.setCreateDate(new Date());</span>
        } else {
<span class="nc" id="L909">            document.setCreateDate(createDate);</span>
        }
        
<span class="fc" id="L912">        documentDao.update(document, principal.getId());</span>
        
        // Update tags
<span class="fc" id="L915">        updateTagList(id, tagList);</span>
        
        // Update relations
<span class="fc" id="L918">        updateRelationList(id, relationList);</span>

        // Update custom metadata
        try {
<span class="fc" id="L922">            MetadataUtil.updateMetadata(document.getId(), metadataIdList, metadataValueList);</span>
<span class="nc" id="L923">        } catch (Exception e) {</span>
<span class="nc" id="L924">            throw new ClientException(&quot;ValidationError&quot;, e.getMessage());</span>
<span class="fc" id="L925">        }</span>

        // Raise a document updated event
<span class="fc" id="L928">        DocumentUpdatedAsyncEvent documentUpdatedAsyncEvent = new DocumentUpdatedAsyncEvent();</span>
<span class="fc" id="L929">        documentUpdatedAsyncEvent.setUserId(principal.getId());</span>
<span class="fc" id="L930">        documentUpdatedAsyncEvent.setDocumentId(id);</span>
<span class="fc" id="L931">        ThreadLocalContext.get().addAsyncEvent(documentUpdatedAsyncEvent);</span>
        
<span class="fc" id="L933">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="fc" id="L934">                .add(&quot;id&quot;, id);</span>
<span class="fc" id="L935">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Import a new document from an EML file.
     *
     * @api {put} /document/eml Import a new document from an EML file
     * @apiName PutDocumentEml
     * @apiGroup Document
     * @apiParam {String} file File data
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiError (server) StreamError Error reading the input file
     * @apiError (server) ErrorGuessMime Error guessing mime type
     * @apiError (client) QuotaReached Quota limit reached
     * @apiError (server) FileError Error adding a file
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @param fileBodyPart File to import
     * @return Response
     */
    @PUT
    @Path(&quot;eml&quot;)
    @Consumes(&quot;multipart/form-data&quot;)
    public Response importEml(@FormDataParam(&quot;file&quot;) FormDataBodyPart fileBodyPart) {
<span class="nc bnc" id="L961" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L962">            throw new ForbiddenClientException();</span>
        }

        // Validate input data
<span class="nc" id="L966">        ValidationUtil.validateRequired(fileBodyPart, &quot;file&quot;);</span>

        // Save the file to a temporary file
        java.nio.file.Path unencryptedFile;
        try {
<span class="nc" id="L971">            unencryptedFile = AppContext.getInstance().getFileService().createTemporaryFile();</span>
<span class="nc" id="L972">            Files.copy(fileBodyPart.getValueAs(InputStream.class), unencryptedFile, StandardCopyOption.REPLACE_EXISTING);</span>
<span class="nc" id="L973">        } catch (IOException e) {</span>
<span class="nc" id="L974">            throw new ServerException(&quot;StreamError&quot;, &quot;Error reading the input file&quot;, e);</span>
<span class="nc" id="L975">        }</span>

        // Read the EML file
<span class="nc" id="L978">        Properties props = new Properties();</span>
<span class="nc" id="L979">        Session mailSession = Session.getDefaultInstance(props, null);</span>
<span class="nc" id="L980">        EmailUtil.MailContent mailContent = new EmailUtil.MailContent();</span>
<span class="nc" id="L981">        try (InputStream inputStream = Files.newInputStream(unencryptedFile)) {</span>
<span class="nc" id="L982">            Message message = new MimeMessage(mailSession, inputStream);</span>
<span class="nc" id="L983">            mailContent.setSubject(message.getSubject());</span>
<span class="nc" id="L984">            mailContent.setDate(message.getSentDate());</span>
<span class="nc" id="L985">            EmailUtil.parseMailContent(message, mailContent);</span>
<span class="nc" id="L986">        } catch (IOException | MessagingException e) {</span>
<span class="nc" id="L987">            throw new ServerException(&quot;StreamError&quot;, &quot;Error reading the temporary file&quot;, e);</span>
<span class="nc" id="L988">        }</span>

        // Create the document
<span class="nc" id="L991">        Document document = new Document();</span>
<span class="nc" id="L992">        document.setUserId(principal.getId());</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">        if (mailContent.getSubject() == null) {</span>
<span class="nc" id="L994">            document.setTitle(&quot;Imported email from EML file&quot;);</span>
        } else {
<span class="nc" id="L996">            document.setTitle(StringUtils.abbreviate(mailContent.getSubject(), 100));</span>
        }
<span class="nc" id="L998">        document.setDescription(StringUtils.abbreviate(mailContent.getMessage(), 4000));</span>
<span class="nc" id="L999">        document.setSubject(StringUtils.abbreviate(mailContent.getSubject(), 500));</span>
<span class="nc" id="L1000">        document.setFormat(&quot;EML&quot;);</span>
<span class="nc" id="L1001">        document.setSource(&quot;Email&quot;);</span>
<span class="nc" id="L1002">        document.setLanguage(ConfigUtil.getConfigStringValue(ConfigType.DEFAULT_LANGUAGE));</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">        if (mailContent.getDate() == null) {</span>
<span class="nc" id="L1004">            document.setCreateDate(new Date());</span>
        } else {
<span class="nc" id="L1006">            document.setCreateDate(mailContent.getDate());</span>
        }

        // Save the document, create the base ACLs
<span class="nc" id="L1010">        DocumentUtil.createDocument(document, principal.getId());</span>

        // Raise a document created event
<span class="nc" id="L1013">        DocumentCreatedAsyncEvent documentCreatedAsyncEvent = new DocumentCreatedAsyncEvent();</span>
<span class="nc" id="L1014">        documentCreatedAsyncEvent.setUserId(principal.getId());</span>
<span class="nc" id="L1015">        documentCreatedAsyncEvent.setDocumentId(document.getId());</span>
<span class="nc" id="L1016">        ThreadLocalContext.get().addAsyncEvent(documentCreatedAsyncEvent);</span>

        // Add files to the document
        try {
<span class="nc bnc" id="L1020" title="All 2 branches missed.">            for (EmailUtil.FileContent fileContent : mailContent.getFileContentList()) {</span>
<span class="nc" id="L1021">                FileUtil.createFile(fileContent.getName(), null, fileContent.getFile(), fileContent.getSize(),</span>
<span class="nc" id="L1022">                        document.getLanguage(), principal.getId(), document.getId());</span>
<span class="nc" id="L1023">            }</span>
<span class="nc" id="L1024">        } catch (IOException e) {</span>
<span class="nc" id="L1025">            throw new ClientException(e.getMessage(), e.getMessage(), e);</span>
<span class="nc" id="L1026">        } catch (Exception e) {</span>
<span class="nc" id="L1027">            throw new ServerException(&quot;FileError&quot;, &quot;Error adding a file&quot;, e);</span>
<span class="nc" id="L1028">        }</span>

<span class="nc" id="L1030">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L1031">                .add(&quot;id&quot;, document.getId());</span>
<span class="nc" id="L1032">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Deletes a document.
     *
     * @api {delete} /document/:id Delete a document
     * @apiName DeleteDocument
     * @apiGroup Document
     * @apiParam {String} id ID
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) NotFound Document not found
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @param id Document ID
     * @return Response
     */
    @DELETE
    @Path(&quot;{id: [a-z0-9\\-]+}&quot;)
    public Response delete(
            @PathParam(&quot;id&quot;) String id) {
<span class="nc bnc" id="L1055" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L1056">            throw new ForbiddenClientException();</span>
        }

        // Get the document
<span class="nc" id="L1060">        DocumentDao documentDao = new DocumentDao();</span>
<span class="nc" id="L1061">        FileDao fileDao = new FileDao();</span>
<span class="nc" id="L1062">        AclDao aclDao = new AclDao();</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">        if (!aclDao.checkPermission(id, PermType.WRITE, getTargetIdList(null))) {</span>
<span class="nc" id="L1064">            throw new NotFoundException();</span>
        }
<span class="nc" id="L1066">        List&lt;File&gt; fileList = fileDao.getByDocumentId(principal.getId(), id);</span>
        
        // Delete the document
<span class="nc" id="L1069">        documentDao.delete(id, principal.getId());</span>

<span class="nc" id="L1071">        long totalSize = 0L;</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">        for (File file : fileList) {</span>
            // Store the file size to update the quota
<span class="nc" id="L1074">            java.nio.file.Path storedFile = DirectoryUtil.getStorageDirectory().resolve(file.getId());</span>
            try {
<span class="nc" id="L1076">                totalSize += Files.size(storedFile);</span>
<span class="nc" id="L1077">            } catch (IOException e) {</span>
                // The file doesn't exists on disk, which is weird, but not fatal
<span class="nc" id="L1079">            }</span>

            // Raise file deleted event
<span class="nc" id="L1082">            FileDeletedAsyncEvent fileDeletedAsyncEvent = new FileDeletedAsyncEvent();</span>
<span class="nc" id="L1083">            fileDeletedAsyncEvent.setUserId(principal.getId());</span>
<span class="nc" id="L1084">            fileDeletedAsyncEvent.setFileId(file.getId());</span>
<span class="nc" id="L1085">            ThreadLocalContext.get().addAsyncEvent(fileDeletedAsyncEvent);</span>
<span class="nc" id="L1086">        }</span>

        // Update the user quota
<span class="nc" id="L1089">        UserDao userDao = new UserDao();</span>
<span class="nc" id="L1090">        User user = userDao.getById(principal.getId());</span>
<span class="nc" id="L1091">        user.setStorageCurrent(user.getStorageCurrent() - totalSize);</span>
<span class="nc" id="L1092">        userDao.updateQuota(user);</span>

        // Raise a document deleted event
<span class="nc" id="L1095">        DocumentDeletedAsyncEvent documentDeletedAsyncEvent = new DocumentDeletedAsyncEvent();</span>
<span class="nc" id="L1096">        documentDeletedAsyncEvent.setUserId(principal.getId());</span>
<span class="nc" id="L1097">        documentDeletedAsyncEvent.setDocumentId(id);</span>
<span class="nc" id="L1098">        ThreadLocalContext.get().addAsyncEvent(documentDeletedAsyncEvent);</span>
        
        // Always return OK
<span class="nc" id="L1101">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L1102">                .add(&quot;status&quot;, &quot;ok&quot;);</span>
<span class="nc" id="L1103">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Update tags list on a document.
     *
     * @param documentId Document ID
     * @param tagList Tag ID list
     */
    private void updateTagList(String documentId, List&lt;String&gt; tagList) {
<span class="pc bpc" id="L1113" title="1 of 2 branches missed.">        if (tagList != null) {</span>
<span class="fc" id="L1114">            TagDao tagDao = new TagDao();</span>
<span class="fc" id="L1115">            Set&lt;String&gt; tagSet = new HashSet&lt;&gt;();</span>
<span class="fc" id="L1116">            Set&lt;String&gt; tagIdSet = new HashSet&lt;&gt;();</span>
<span class="fc" id="L1117">            List&lt;TagDto&gt; tagDtoList = tagDao.findByCriteria(new TagCriteria().setTargetIdList(getTargetIdList(null)), null);</span>
<span class="fc bfc" id="L1118" title="All 2 branches covered.">            for (TagDto tagDto : tagDtoList) {</span>
<span class="fc" id="L1119">                tagIdSet.add(tagDto.getId());</span>
<span class="fc" id="L1120">            }</span>
<span class="fc bfc" id="L1121" title="All 2 branches covered.">            for (String tagId : tagList) {</span>
<span class="pc bpc" id="L1122" title="1 of 2 branches missed.">                if (!tagIdSet.contains(tagId)) {</span>
<span class="nc" id="L1123">                    throw new ClientException(&quot;TagNotFound&quot;, MessageFormat.format(&quot;Tag not found: {0}&quot;, tagId));</span>
                }
<span class="fc" id="L1125">                tagSet.add(tagId);</span>
<span class="fc" id="L1126">            }</span>
<span class="fc" id="L1127">            tagDao.updateTagList(documentId, tagSet);</span>
        }
<span class="fc" id="L1129">    }</span>

    /**
     * Update relations list on a document.
     *
     * @param documentId Document ID
     * @param relationList Relation ID list
     */
    private void updateRelationList(String documentId, List&lt;String&gt; relationList) {
<span class="pc bpc" id="L1138" title="1 of 2 branches missed.">        if (relationList != null) {</span>
<span class="fc" id="L1139">            DocumentDao documentDao = new DocumentDao();</span>
<span class="fc" id="L1140">            RelationDao relationDao = new RelationDao();</span>
<span class="fc" id="L1141">            Set&lt;String&gt; documentIdSet = new HashSet&lt;&gt;();</span>
<span class="pc bpc" id="L1142" title="1 of 2 branches missed.">            for (String targetDocId : relationList) {</span>
                // ACL are not checked, because the editing user is not forced to view the target document
<span class="nc" id="L1144">                Document document = documentDao.getById(targetDocId);</span>
<span class="nc bnc" id="L1145" title="All 4 branches missed.">                if (document != null &amp;&amp; !documentId.equals(targetDocId)) {</span>
<span class="nc" id="L1146">                    documentIdSet.add(targetDocId);</span>
                }
<span class="nc" id="L1148">            }</span>
<span class="fc" id="L1149">            relationDao.updateRelationList(documentId, documentIdSet);</span>
        }
<span class="fc" id="L1151">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>