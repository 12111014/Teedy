<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommentResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Docs Web</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.rest.resource</a> &gt; <span class="el_source">CommentResource.java</span></div><h1>CommentResource.java</h1><pre class="source lang-java linenums">package com.sismics.docs.rest.resource;

import com.sismics.docs.core.constant.PermType;
import com.sismics.docs.core.dao.AclDao;
import com.sismics.docs.core.dao.CommentDao;
import com.sismics.docs.core.dao.dto.CommentDto;
import com.sismics.docs.core.model.jpa.Comment;
import com.sismics.rest.exception.ForbiddenClientException;
import com.sismics.rest.util.ValidationUtil;
import com.sismics.util.ImageUtil;

import javax.json.Json;
import javax.json.JsonArrayBuilder;
import javax.json.JsonObjectBuilder;
import javax.ws.rs.*;
import javax.ws.rs.core.Response;
import java.util.List;

/**
 * Comment REST resource.
 * 
 * @author bgamard
 */
@Path(&quot;/comment&quot;)
<span class="nc" id="L25">public class CommentResource extends BaseResource {</span>
    /**
     * Add a comment.
     *
     * @api {put} /comment Add a comment
     * @apiName PutComment
     * @apiGroup Comment
     * @apiParam {String} id Document ID
     * @apiParam {String} content Comment content
     * @apiSuccess {String} id Comment ID
     * @apiSuccess {String} content Content
     * @apiSuccess {String} creator Username
     * @apiSuccess {String} creator_gravatar Creator Gravatar hash
     * @apiSuccess {Number} create_date Create date (timestamp)
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiError (client) NotFound Document not found
     * @apiPermission user
     * @apiVersion 1.5.0
     * 
     * @param documentId Document ID
     * @param content Comment content
     * @return Response
     */
    @PUT
    public Response add(@FormParam(&quot;id&quot;) String documentId,
            @FormParam(&quot;content&quot;) String content) {
<span class="nc bnc" id="L52" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L53">            throw new ForbiddenClientException();</span>
        }
        
        // Validate input data
<span class="nc" id="L57">        ValidationUtil.validateRequired(documentId, &quot;id&quot;);</span>
<span class="nc" id="L58">        content = ValidationUtil.validateLength(content, &quot;content&quot;, 1, 4000, false);</span>
        
        // Read access on doc gives access to write comments 
<span class="nc" id="L61">        AclDao aclDao = new AclDao();</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (!aclDao.checkPermission(documentId, PermType.READ, getTargetIdList(null))) {</span>
<span class="nc" id="L63">            throw new NotFoundException();</span>
        }
        
        // Create the comment
<span class="nc" id="L67">        Comment comment = new Comment();</span>
<span class="nc" id="L68">        comment.setDocumentId(documentId);</span>
<span class="nc" id="L69">        comment.setContent(content);</span>
<span class="nc" id="L70">        comment.setUserId(principal.getId());</span>
<span class="nc" id="L71">        CommentDao commentDao = new CommentDao();</span>
<span class="nc" id="L72">        commentDao.create(comment, principal.getId());</span>
        
        // Returns the comment
<span class="nc" id="L75">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L76">                .add(&quot;id&quot;, comment.getId())</span>
<span class="nc" id="L77">                .add(&quot;content&quot;, comment.getContent())</span>
<span class="nc" id="L78">                .add(&quot;creator&quot;, principal.getName())</span>
<span class="nc" id="L79">                .add(&quot;creator_gravatar&quot;, ImageUtil.computeGravatar(principal.getEmail()))</span>
<span class="nc" id="L80">                .add(&quot;create_date&quot;, comment.getCreateDate().getTime());</span>
<span class="nc" id="L81">        return Response.ok().entity(response.build()).build();</span>
    }
    
    /**
     * Delete a comment.
     *
     * @api {delete} /comment/:id Delete a comment
     * @apiName DeleteComment
     * @apiGroup Comment
     * @apiParam {String} id Comment ID
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) NotFound Comment or document not found
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @param id Comment ID
     * @return Response
     */
    @DELETE
    @Path(&quot;{id: [a-z0-9\\-]+}&quot;)
    public Response delete(@PathParam(&quot;id&quot;) String id) {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L104">            throw new ForbiddenClientException();</span>
        }
        
        // Get the comment
<span class="nc" id="L108">        CommentDao commentDao = new CommentDao();</span>
<span class="nc" id="L109">        Comment comment = commentDao.getActiveById(id);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (comment == null) {</span>
<span class="nc" id="L111">            throw new NotFoundException();</span>
        }
        
        // If the current user owns the comment, skip ACL check
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (!comment.getUserId().equals(principal.getId())) {</span>
            // Get the associated document
<span class="nc" id="L117">            AclDao aclDao = new AclDao();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (!aclDao.checkPermission(comment.getDocumentId(), PermType.WRITE, getTargetIdList(null))) {</span>
<span class="nc" id="L119">                throw new NotFoundException();</span>
            }
        }
        
        // Delete the comment
<span class="nc" id="L124">        commentDao.delete(id, principal.getId());</span>
        
        // Always return OK
<span class="nc" id="L127">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L128">                .add(&quot;status&quot;, &quot;ok&quot;);</span>
<span class="nc" id="L129">        return Response.ok().entity(response.build()).build();</span>
    }
    
    /**
     * Get all comments on a document.
     *
     * @api {get} /comment/:id Get comments
     * @apiName GetComment
     * @apiGroup Comment
     * @apiParam {String} id Document ID
     * @apiParam {String} share Share ID
     * @apiSuccess {Object[]} comments List of comments
     * @apiSuccess {String} comments.id Comment ID
     * @apiSuccess {String} comments.content Content
     * @apiSuccess {String} comments.creator Username
     * @apiSuccess {String} comments.creator_gravatar Creator Gravatar hash
     * @apiSuccess {Number} comments.create_date Create date (timestamp)
     * @apiError (client) NotFound Document not found
     * @apiPermission none
     * @apiVersion 1.5.0
     *
     * @param documentId DocumentID
     * @return Response
     */
    @GET
    @Path(&quot;{documentId: [a-z0-9\\-]+}&quot;)
    public Response get(@PathParam(&quot;documentId&quot;) String documentId,
            @QueryParam(&quot;share&quot;) String shareId) {
<span class="nc" id="L157">        authenticate();</span>
        
        // Read access on doc gives access to read comments 
<span class="nc" id="L160">        AclDao aclDao = new AclDao();</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!aclDao.checkPermission(documentId, PermType.READ, getTargetIdList(shareId))) {</span>
<span class="nc" id="L162">            throw new NotFoundException();</span>
        }
        
        // Assemble results
<span class="nc" id="L166">        CommentDao commentDao = new CommentDao();</span>
<span class="nc" id="L167">        List&lt;CommentDto&gt; commentDtoList = commentDao.getByDocumentId(documentId);</span>
<span class="nc" id="L168">        JsonArrayBuilder comments = Json.createArrayBuilder();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        for (CommentDto commentDto : commentDtoList) {</span>
<span class="nc" id="L170">            comments.add(Json.createObjectBuilder()</span>
<span class="nc" id="L171">                    .add(&quot;id&quot;, commentDto.getId())</span>
<span class="nc" id="L172">                    .add(&quot;content&quot;, commentDto.getContent())</span>
<span class="nc" id="L173">                    .add(&quot;creator&quot;, commentDto.getCreatorName())</span>
<span class="nc" id="L174">                    .add(&quot;creator_gravatar&quot;, ImageUtil.computeGravatar(commentDto.getCreatorEmail()))</span>
<span class="nc" id="L175">                    .add(&quot;create_date&quot;, commentDto.getCreateTimestamp()));</span>
<span class="nc" id="L176">        }</span>
        
        // Always return OK
<span class="nc" id="L179">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L180">                .add(&quot;comments&quot;, comments);</span>
<span class="nc" id="L181">        return Response.ok().entity(response.build()).build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>