<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThemeResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Docs Web</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.rest.resource</a> &gt; <span class="el_source">ThemeResource.java</span></div><h1>ThemeResource.java</h1><pre class="source lang-java linenums">package com.sismics.docs.rest.resource;

import com.google.common.base.Strings;
import com.google.common.io.ByteStreams;
import com.sismics.docs.core.constant.ConfigType;
import com.sismics.docs.core.dao.ConfigDao;
import com.sismics.docs.core.model.jpa.Config;
import com.sismics.docs.core.util.DirectoryUtil;
import com.sismics.docs.rest.constant.BaseFunction;
import com.sismics.rest.exception.ClientException;
import com.sismics.rest.exception.ForbiddenClientException;
import com.sismics.rest.exception.ServerException;
import com.sismics.rest.util.ValidationUtil;
import com.sismics.util.HttpUtil;
import com.sismics.util.JsonUtil;
import com.sismics.util.css.Selector;
import org.glassfish.jersey.media.multipart.FormDataBodyPart;
import org.glassfish.jersey.media.multipart.FormDataParam;

import javax.json.*;
import javax.ws.rs.*;
import javax.ws.rs.core.HttpHeaders;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.StreamingOutput;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.StringReader;
import java.nio.file.Files;
import java.nio.file.StandardCopyOption;
import java.util.Map;

/**
 * Theme REST resources.
 * 
 * @author bgamard
 */
@Path(&quot;/theme&quot;)
<span class="nc" id="L39">public class ThemeResource extends BaseResource {</span>
	/**
     * Returns custom CSS stylesheet.
     *
     * @api {get} /theme/stylesheet Get the CSS stylesheet
     * @apiName GetThemeStylesheet
     * @apiGroup Theme
     * @apiSuccess {String} stylesheet The whole response is the stylesheet
     * @apiPermission none
     * @apiVersion 1.5.0
     *
     * @return Response
     */
    @GET
    @Path(&quot;/stylesheet&quot;)
    @Produces(&quot;text/css&quot;)
    public Response stylesheet() {
<span class="nc" id="L56">        JsonObject themeConfig = getThemeConfig();</span>

        // Build the stylesheet
<span class="nc" id="L59">    	StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L60">    	sb.append(new Selector(&quot;.navbar&quot;)</span>
<span class="nc" id="L61">            .rule(&quot;background-color&quot;, themeConfig.getString(&quot;color&quot;, &quot;#ffffff&quot;)));</span>
<span class="nc" id="L62">        sb.append(themeConfig.getString(&quot;css&quot;, &quot;&quot;));</span>

<span class="nc" id="L64">        return Response.ok().entity(sb.toString()).build();</span>
    }

    /**
     * Returns the theme configuration.
     *
     * @api {get} /theme Get the theme configuration
     * @apiName GetTheme
     * @apiGroup Theme
     * @apiSuccess {String} name Application name
     * @apiSuccess {String} color Main color
     * @apiSuccess {String} css Custom CSS
     * @apiPermission none
     * @apiVersion 1.5.0
     *
     * @return Response
     */
    @GET
    public Response get() {
<span class="nc" id="L83">        JsonObject themeConfig = getThemeConfig();</span>
<span class="nc" id="L84">        JsonObjectBuilder json = Json.createObjectBuilder();</span>
<span class="nc" id="L85">        json.add(&quot;name&quot;, themeConfig.getString(&quot;name&quot;, &quot;Teedy&quot;));</span>
<span class="nc" id="L86">        json.add(&quot;color&quot;, themeConfig.getString(&quot;color&quot;, &quot;#ffffff&quot;));</span>
<span class="nc" id="L87">        json.add(&quot;css&quot;, themeConfig.getString(&quot;css&quot;, &quot;&quot;));</span>
<span class="nc" id="L88">        return Response.ok().entity(json.build()).build();</span>
    }

    /**
     * Change the theme configuration.
     *
     * @api {post} /theme Change the theme configuration
     * @apiName PostTheme
     * @apiGroup Theme
     * @apiParam {String} name Application name
     * @apiParam {String} color Main color
     * @apiParam {String} css Custom CSS
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiPermission admin
     * @apiVersion 1.5.0
     *
     * @param color Theme color
     * @param name Application name
     * @param css Custom CSS
     * @return Response
     */
    @POST
    public Response theme(@FormParam(&quot;color&quot;) String color,
              @FormParam(&quot;name&quot;) String name,
              @FormParam(&quot;css&quot;) String css) {
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L116">            throw new ForbiddenClientException();</span>
        }
<span class="nc" id="L118">        checkBaseFunction(BaseFunction.ADMIN);</span>

        // Validate input data
<span class="nc" id="L121">        ValidationUtil.validateHexColor(color, &quot;color&quot;, true);</span>
<span class="nc" id="L122">        name = ValidationUtil.validateLength(name, &quot;name&quot;, 3, 30, true);</span>

        // Update the JSON
<span class="nc" id="L125">        JsonObjectBuilder json = getMutableThemeConfig();</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (Strings.isNullOrEmpty(color)) {</span>
<span class="nc" id="L127">            json.add(&quot;color&quot;, JsonValue.NULL);</span>
        } else {
<span class="nc" id="L129">            json.add(&quot;color&quot;, color);</span>
        }
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (Strings.isNullOrEmpty(name)) {</span>
<span class="nc" id="L132">            json.add(&quot;name&quot;, JsonValue.NULL);</span>
        } else {
<span class="nc" id="L134">            json.add(&quot;name&quot;, name);</span>
        }
<span class="nc" id="L136">        json.add(&quot;css&quot;, JsonUtil.nullable(css));</span>

        // Persist the new configuration
<span class="nc" id="L139">        ConfigDao configDao = new ConfigDao();</span>
<span class="nc" id="L140">        configDao.update(ConfigType.THEME, json.build().toString());</span>

        // Always return OK
<span class="nc" id="L143">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L144">                .add(&quot;status&quot;, &quot;ok&quot;);</span>
<span class="nc" id="L145">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Change a theme image.
     *
     * @api {put} /theme/image/:type Change a theme image
     * @apiDescription This resource accepts only multipart/form-data.
     * @apiName PutThemeImage
     * @apiGroup Theme
     * @apiParam {String=&quot;logo&quot;,&quot;background&quot;} type Image type
     * @apiParam {String} image Image data
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) NoImageProvided An image is required
     * @apiError (server) CopyError Error copying the image to the theme directory
     * @apiPermission admin
     * @apiVersion 1.5.0
     *
     * @param type Image type
     * @param imageBodyPart Image data
     * @return Response
     */
    @PUT
    @Path(&quot;image/{type: logo|background}&quot;)
    @Consumes(&quot;multipart/form-data&quot;)
    public Response images(@PathParam(&quot;type&quot;) String type,
            @FormDataParam(&quot;image&quot;) FormDataBodyPart imageBodyPart) {
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L174">            throw new ForbiddenClientException();</span>
        }
<span class="nc" id="L176">        checkBaseFunction(BaseFunction.ADMIN);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (imageBodyPart == null) {</span>
<span class="nc" id="L178">            throw new ClientException(&quot;NoImageProvided&quot;, &quot;An image is required&quot;);</span>
        }

        // Only a background or a logo is handled
<span class="nc" id="L182">        java.nio.file.Path filePath = DirectoryUtil.getThemeDirectory().resolve(type);</span>

        // Copy the image to the theme directory
<span class="nc" id="L185">        try (InputStream inputStream = imageBodyPart.getValueAs(InputStream.class)) {</span>
<span class="nc" id="L186">            Files.copy(inputStream, filePath, StandardCopyOption.REPLACE_EXISTING);</span>
<span class="nc" id="L187">        } catch (Exception e) {</span>
<span class="nc" id="L188">            throw new ServerException(&quot;CopyError&quot;, &quot;Error copying the image to the theme directory&quot;, e);</span>
<span class="nc" id="L189">        }</span>

<span class="nc" id="L191">        return Response.ok().build();</span>
    }

    /**
     * Get theme images.
     *
     * @api {get} /theme/image/:type Get a theme image
     * @apiName GetThemeImage
     * @apiGroup Theme
     * @apiParam {String=&quot;logo&quot;,&quot;background&quot;} type Image type
     * @apiSuccess {String} image The whole response is the image
     * @apiPermission none
     * @apiVersion 1.5.0
     *
     * @param type Image type
     * @return Response
     */
    @GET
    @Produces(&quot;image/*&quot;)
    @Path(&quot;image/{type: logo|background}&quot;)
    public Response getImage(@PathParam(&quot;type&quot;) final String type) {
<span class="nc" id="L212">        final java.nio.file.Path filePath = DirectoryUtil.getThemeDirectory().resolve(type);</span>

        // Copy the image to the response output
<span class="nc" id="L215">        return Response.ok(new StreamingOutput() {</span>
            @Override
            public void write(OutputStream outputStream) throws IOException, WebApplicationException {
<span class="nc" id="L218">                InputStream inputStream = null;</span>
                try {
<span class="nc bnc" id="L220" title="All 2 branches missed.">                    if (Files.exists(filePath)) {</span>
<span class="nc" id="L221">                        inputStream = Files.newInputStream(filePath);</span>
                    } else {
<span class="nc bnc" id="L223" title="All 2 branches missed.">                        inputStream = getClass().getResource(&quot;/image/&quot; + (type.equals(&quot;logo&quot;) ? &quot;logo.png&quot; : &quot;background.jpg&quot;)).openStream();</span>
                    }
<span class="nc" id="L225">                    ByteStreams.copy(inputStream, outputStream);</span>
                } finally {
                    try {
<span class="nc bnc" id="L228" title="All 2 branches missed.">                        if (inputStream != null) {</span>
<span class="nc" id="L229">                            inputStream.close();</span>
                        }
<span class="nc" id="L231">                        outputStream.close();</span>
<span class="nc" id="L232">                    } catch (IOException e) {</span>
                        // Ignore
<span class="nc" id="L234">                    }</span>
                }
<span class="nc" id="L236">            }</span>
        })
<span class="nc" id="L238">        .header(HttpHeaders.CONTENT_TYPE, &quot;image/*&quot;)</span>
<span class="nc" id="L239">        .header(HttpHeaders.CACHE_CONTROL, &quot;public&quot;)</span>
<span class="nc" id="L240">        .header(HttpHeaders.EXPIRES, HttpUtil.buildExpiresHeader(3_600_000L * 24L * 15L))</span>
<span class="nc" id="L241">        .build();</span>
    }

    /**
     * Returns the theme configuration object.
     *
     * @return Theme configuration
     */
    private JsonObject getThemeConfig() {
<span class="nc" id="L250">        ConfigDao configDao = new ConfigDao();</span>
<span class="nc" id="L251">        Config themeConfig = configDao.getById(ConfigType.THEME);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (themeConfig == null) {</span>
<span class="nc" id="L253">            return Json.createObjectBuilder().build();</span>
        }

<span class="nc" id="L256">        try (JsonReader reader = Json.createReader(new StringReader(themeConfig.getValue()))) {</span>
<span class="nc" id="L257">            return reader.readObject();</span>
        }
    }

    /**
     * Returns a mutable theme configuration.
     *
     * @return Json builder
     */
    private JsonObjectBuilder getMutableThemeConfig() {
<span class="nc" id="L267">        JsonObject themeConfig = getThemeConfig();</span>
<span class="nc" id="L268">        JsonObjectBuilder json = Json.createObjectBuilder();</span>

<span class="nc bnc" id="L270" title="All 2 branches missed.">        for (Map.Entry&lt;String, JsonValue&gt; entry : themeConfig.entrySet()) {</span>
<span class="nc" id="L271">            json.add(entry.getKey(), entry.getValue());</span>
<span class="nc" id="L272">        }</span>

<span class="nc" id="L274">        return json;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>