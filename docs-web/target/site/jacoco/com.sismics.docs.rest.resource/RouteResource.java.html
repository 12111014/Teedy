<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RouteResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Docs Web</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.rest.resource</a> &gt; <span class="el_source">RouteResource.java</span></div><h1>RouteResource.java</h1><pre class="source lang-java linenums">package com.sismics.docs.rest.resource;

import com.sismics.docs.core.constant.*;
import com.sismics.docs.core.dao.*;
import com.sismics.docs.core.dao.criteria.RouteCriteria;
import com.sismics.docs.core.dao.criteria.RouteStepCriteria;
import com.sismics.docs.core.dao.dto.DocumentDto;
import com.sismics.docs.core.dao.dto.RouteDto;
import com.sismics.docs.core.dao.dto.RouteStepDto;
import com.sismics.docs.core.model.jpa.Route;
import com.sismics.docs.core.model.jpa.RouteModel;
import com.sismics.docs.core.model.jpa.RouteStep;
import com.sismics.docs.core.util.ActionUtil;
import com.sismics.docs.core.util.RoutingUtil;
import com.sismics.docs.core.util.SecurityUtil;
import com.sismics.docs.core.util.jpa.SortCriteria;
import com.sismics.rest.exception.ClientException;
import com.sismics.rest.exception.ForbiddenClientException;
import com.sismics.rest.util.ValidationUtil;

import javax.json.*;
import javax.ws.rs.*;
import javax.ws.rs.core.Response;
import java.io.StringReader;
import java.util.List;

/**
 * Route REST resources.
 * 
 * @author bgamard
 */
@Path(&quot;/route&quot;)
<span class="nc" id="L33">public class RouteResource extends BaseResource {</span>
    /**
     * Start a route on a document.
     *
     * @api {post} /route/start Start a route on a document
     * @apiName PostRouteStart
     * @apiGroup Route
     * @apiParam {String} routeModelId Route model ID
     * @apiParam {String} documentId Document ID
     * @apiSuccess {String} status Status OK
     * @apiError (client) InvalidRouteModel Invalid route model
     * @apiError (client) RunningRoute A running route already exists on this document
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) NotFound Route model or document not found
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @return Response
     */
    @POST
    @Path(&quot;start&quot;)
    public Response start(@FormParam(&quot;routeModelId&quot;) String routeModelId,
                          @FormParam(&quot;documentId&quot;) String documentId) {
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L57">            throw new ForbiddenClientException();</span>
        }

        // Get the document
<span class="nc" id="L61">        AclDao aclDao = new AclDao();</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (!aclDao.checkPermission(documentId, PermType.WRITE, getTargetIdList(null))) {</span>
<span class="nc" id="L63">            throw new NotFoundException();</span>
        }

        // Get the route model
<span class="nc" id="L67">        RouteModelDao routeModelDao = new RouteModelDao();</span>
<span class="nc" id="L68">        RouteModel routeModel = routeModelDao.getActiveById(routeModelId);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (routeModel == null) {</span>
<span class="nc" id="L70">            throw new NotFoundException();</span>
        }

        // Check permission on this route model
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (!aclDao.checkPermission(routeModelId, PermType.READ, getTargetIdList(null))) {</span>
<span class="nc" id="L75">            throw new ForbiddenClientException();</span>
        }

        // Avoid creating 2 running routes on the same document
<span class="nc" id="L79">        RouteStepDao routeStepDao = new RouteStepDao();</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (routeStepDao.getCurrentStep(documentId) != null) {</span>
<span class="nc" id="L81">            throw new ClientException(&quot;RunningRoute&quot;, &quot;A running route already exists on this document&quot;);</span>
        }

        // Create the route
<span class="nc" id="L85">        Route route = new Route()</span>
<span class="nc" id="L86">                .setDocumentId(documentId)</span>
<span class="nc" id="L87">                .setName(routeModel.getName());</span>
<span class="nc" id="L88">        RouteDao routeDao = new RouteDao();</span>
<span class="nc" id="L89">        routeDao.create(route, principal.getId());</span>

        // Create the steps
<span class="nc" id="L92">        try (JsonReader reader = Json.createReader(new StringReader(routeModel.getSteps()))) {</span>
<span class="nc" id="L93">            JsonArray stepsJson = reader.readArray();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            for (int order = 0; order &lt; stepsJson.size(); order++) {</span>
<span class="nc" id="L95">                JsonObject step = stepsJson.getJsonObject(order);</span>
<span class="nc" id="L96">                JsonObject target = step.getJsonObject(&quot;target&quot;);</span>
<span class="nc" id="L97">                AclTargetType targetType = AclTargetType.valueOf(target.getString(&quot;type&quot;));</span>
<span class="nc" id="L98">                String targetName = target.getString(&quot;name&quot;);</span>
<span class="nc" id="L99">                String transitions = null;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (step.containsKey(&quot;transitions&quot;)) {</span>
<span class="nc" id="L101">                    transitions = step.getJsonArray(&quot;transitions&quot;).toString();</span>
                }

<span class="nc" id="L104">                RouteStep routeStep = new RouteStep()</span>
<span class="nc" id="L105">                        .setRouteId(route.getId())</span>
<span class="nc" id="L106">                        .setName(step.getString(&quot;name&quot;))</span>
<span class="nc" id="L107">                        .setOrder(order)</span>
<span class="nc" id="L108">                        .setType(RouteStepType.valueOf(step.getString(&quot;type&quot;)))</span>
<span class="nc" id="L109">                        .setTransitions(transitions)</span>
<span class="nc" id="L110">                        .setTargetId(SecurityUtil.getTargetIdFromName(targetName, targetType));</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">                if (routeStep.getTargetId() == null) {</span>
<span class="nc" id="L113">                    throw new ClientException(&quot;InvalidRouteModel&quot;, &quot;A step has an invalid target&quot;);</span>
                }

<span class="nc" id="L116">                routeStepDao.create(routeStep);</span>
            }
        }

        // Intialize ACLs on the first step
<span class="nc" id="L121">        RouteStepDto routeStepDto = routeStepDao.getCurrentStep(documentId);</span>
<span class="nc" id="L122">        RoutingUtil.updateAcl(documentId, routeStepDto, null, principal.getId());</span>
<span class="nc" id="L123">        RoutingUtil.sendRouteStepEmail(documentId, routeStepDto);</span>

<span class="nc" id="L125">        JsonObjectBuilder step = routeStepDto.toJson();</span>
<span class="nc" id="L126">        step.add(&quot;transitionable&quot;, getTargetIdList(null).contains(routeStepDto.getTargetId()));</span>
<span class="nc" id="L127">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L128">                .add(&quot;route_step&quot;, step);</span>
<span class="nc" id="L129">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Validate the current step of a route.
     *
     * @api {post} /route/validate Validate the current step of a route
     * @apiName PostRouteValidate
     * @apiGroup Route
     * @apiParam {String} documentId Document ID
     * @apiParam {String} transition Route step transition
     * @apiParam {String} comment Route step comment
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) NotFound Document or route not found
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @return Response
     */
    @POST
    @Path(&quot;validate&quot;)
    public Response validate(@FormParam(&quot;documentId&quot;) String documentId,
                             @FormParam(&quot;transition&quot;) String transitionStr,
                             @FormParam(&quot;comment&quot;) String comment) {
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L155">            throw new ForbiddenClientException();</span>
        }

        // Get the document
<span class="nc" id="L159">        AclDao aclDao = new AclDao();</span>
<span class="nc" id="L160">        DocumentDao documentDao = new DocumentDao();</span>
<span class="nc" id="L161">        DocumentDto documentDto = documentDao.getDocument(documentId, PermType.READ, getTargetIdList(null));</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (documentDto == null) {</span>
<span class="nc" id="L163">            throw new NotFoundException();</span>
        }

        // Get the current step
<span class="nc" id="L167">        RouteStepDao routeStepDao = new RouteStepDao();</span>
<span class="nc" id="L168">        RouteStepDto routeStepDto = routeStepDao.getCurrentStep(documentId);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (routeStepDto == null) {</span>
<span class="nc" id="L170">            throw new NotFoundException();</span>
        }

        // Check permission to validate this step
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (!getTargetIdList(null).contains(routeStepDto.getTargetId())) {</span>
<span class="nc" id="L175">            throw new ForbiddenClientException();</span>
        }

        // Validate data
<span class="nc" id="L179">        ValidationUtil.validateRequired(transitionStr, &quot;transition&quot;);</span>
<span class="nc" id="L180">        comment = ValidationUtil.validateLength(comment, &quot;comment&quot;, 1, 500, true);</span>
<span class="nc" id="L181">        RouteStepTransition routeStepTransition = RouteStepTransition.valueOf(transitionStr);</span>
<span class="nc bnc" id="L182" title="All 4 branches missed.">        if (routeStepDto.getType() == RouteStepType.VALIDATE &amp;&amp; routeStepTransition != RouteStepTransition.VALIDATED</span>
<span class="nc bnc" id="L183" title="All 6 branches missed.">                || routeStepDto.getType() == RouteStepType.APPROVE</span>
                &amp;&amp; routeStepTransition != RouteStepTransition.APPROVED &amp;&amp; routeStepTransition != RouteStepTransition.REJECTED) {
<span class="nc" id="L185">            throw new ClientException(&quot;ValidationError&quot;, &quot;Invalid transition for this route step type&quot;);</span>
        }

        // Execute actions
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (routeStepDto.getTransitions() != null) {</span>
<span class="nc" id="L190">            try (JsonReader reader = Json.createReader(new StringReader(routeStepDto.getTransitions()))) {</span>
<span class="nc" id="L191">                JsonArray transitions = reader.readArray();</span>
                // Filter out our transition
<span class="nc bnc" id="L193" title="All 2 branches missed.">                for (int i = 0; i &lt; transitions.size(); i++) {</span>
<span class="nc" id="L194">                    JsonObject transition = transitions.getJsonObject(i);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                    if (transition.getString(&quot;name&quot;).equals(routeStepTransition.name())) {</span>
                        // Transition found, execute those actions
<span class="nc" id="L197">                        JsonArray actions = transition.getJsonArray(&quot;actions&quot;);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">                        for (int j = 0; j &lt; actions.size(); j++) {</span>
<span class="nc" id="L199">                            JsonObject action = actions.getJsonObject(j);</span>
<span class="nc" id="L200">                            ActionType actionType = ActionType.valueOf(action.getString(&quot;type&quot;));</span>
<span class="nc" id="L201">                            ActionUtil.executeAction(actionType, action, documentDto);</span>
                        }
                    }
                }
            }
        }

        // Validate the step and update ACLs
<span class="nc" id="L209">        routeStepDao.endRouteStep(routeStepDto.getId(), routeStepTransition, comment, principal.getId());</span>
<span class="nc" id="L210">        RouteStepDto newRouteStep = routeStepDao.getCurrentStep(documentId);</span>
<span class="nc" id="L211">        RoutingUtil.updateAcl(documentId, newRouteStep, routeStepDto, principal.getId());</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (newRouteStep != null) {</span>
<span class="nc" id="L213">            RoutingUtil.sendRouteStepEmail(documentId, newRouteStep);</span>
        }

<span class="nc" id="L216">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L217">                .add(&quot;readable&quot;, aclDao.checkPermission(documentId, PermType.READ, getTargetIdList(null)));</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (newRouteStep != null) {</span>
<span class="nc" id="L219">            JsonObjectBuilder step = newRouteStep.toJson();</span>
<span class="nc" id="L220">            step.add(&quot;transitionable&quot;, getTargetIdList(null).contains(newRouteStep.getTargetId()));</span>
<span class="nc" id="L221">            response.add(&quot;route_step&quot;, step);</span>
        }
<span class="nc" id="L223">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Returns the routes on a document.
     *
     * @api {get} /route Get the routes on a document
     * @apiName GetRoutes
     * @apiGroup Route
     * @apiParam {String} documentId Document ID
     * @apiSuccess {Object[]} routes List of routes
     * @apiSuccess {String} routes.name Name
     * @apiSuccess {Number} routes.create_date Create date (timestamp)
     * @apiSuccess {Object[]} routes.steps Route steps
     * @apiSuccess {String} routes.steps.name Route step name
     * @apiSuccess {String=&quot;APPROVE&quot;, &quot;VALIDATE&quot;} routes.steps.type Route step type
     * @apiSuccess {String} routes.steps.comment Route step comment
     * @apiSuccess {Number} routes.steps.end_date Route step end date (timestamp)
     * @apiSuccess {String=&quot;APPROVED&quot;,&quot;REJECTED&quot;,&quot;VALIDATED&quot;} routes.steps.transition Route step transition
     * @apiSuccess {Object} routes.steps.validator_username Validator username
     * @apiSuccess {Object} routes.steps.target Route step target
     * @apiSuccess {String} routes.steps.target.id Route step target ID
     * @apiSuccess {String} routes.steps.target.name Route step target name
     * @apiSuccess {String=&quot;USER&quot;,&quot;GROUP&quot;} routes.steps.target.type Route step target type
     * @apiError (client) NotFound Document not found
     * @apiPermission none
     * @apiVersion 1.5.0
     *
     * @param documentId Document ID
     * @return Response
     */
    @GET
    public Response get(@QueryParam(&quot;documentId&quot;) String documentId) {
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L257">            throw new ForbiddenClientException();</span>
        }

<span class="nc" id="L260">        DocumentDao documentDao = new DocumentDao();</span>
<span class="nc" id="L261">        DocumentDto documentDto = documentDao.getDocument(documentId, PermType.READ, getTargetIdList(null));</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (documentDto == null) {</span>
<span class="nc" id="L263">            throw new NotFoundException();</span>
        }

<span class="nc" id="L266">        JsonArrayBuilder routes = Json.createArrayBuilder();</span>

<span class="nc" id="L268">        RouteDao routeDao = new RouteDao();</span>
<span class="nc" id="L269">        RouteStepDao routeStepDao = new RouteStepDao();</span>
<span class="nc" id="L270">        List&lt;RouteDto&gt; routeDtoList = routeDao.findByCriteria(new RouteCriteria()</span>
<span class="nc" id="L271">                .setDocumentId(documentId), new SortCriteria(2, false));</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        for (RouteDto routeDto : routeDtoList) {</span>
<span class="nc" id="L273">            List&lt;RouteStepDto&gt; routeStepDtoList = routeStepDao.findByCriteria(new RouteStepCriteria()</span>
<span class="nc" id="L274">                    .setRouteId(routeDto.getId()), new SortCriteria(6, true));</span>
<span class="nc" id="L275">            JsonArrayBuilder steps = Json.createArrayBuilder();</span>

<span class="nc bnc" id="L277" title="All 2 branches missed.">            for (RouteStepDto routeStepDto : routeStepDtoList) {</span>
<span class="nc" id="L278">                steps.add(routeStepDto.toJson());</span>
<span class="nc" id="L279">            }</span>

<span class="nc" id="L281">            routes.add(Json.createObjectBuilder()</span>
<span class="nc" id="L282">                    .add(&quot;name&quot;, routeDto.getName())</span>
<span class="nc" id="L283">                    .add(&quot;create_date&quot;, routeDto.getCreateTimestamp())</span>
<span class="nc" id="L284">                    .add(&quot;steps&quot;, steps));</span>
<span class="nc" id="L285">        }</span>

<span class="nc" id="L287">        JsonObjectBuilder json = Json.createObjectBuilder()</span>
<span class="nc" id="L288">                .add(&quot;routes&quot;, routes);</span>
<span class="nc" id="L289">        return Response.ok().entity(json.build()).build();</span>
    }

    /**
     * Cancel a route.
     *
     * @api {delete} /route Cancel a route
     * @apiName DeleteRoute
     * @apiGroup Route
     * @apiParam {String} documentId Document ID
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) NotFound Document or route not found
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @return Response
     */
    @DELETE
    public Response delete(@QueryParam(&quot;documentId&quot;) String documentId) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L310">            throw new ForbiddenClientException();</span>
        }

        // Get the document
<span class="nc" id="L314">        AclDao aclDao = new AclDao();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (!aclDao.checkPermission(documentId, PermType.WRITE, getTargetIdList(null))) {</span>
<span class="nc" id="L316">            throw new NotFoundException();</span>
        }

        // Get the current step
<span class="nc" id="L320">        RouteStepDao routeStepDao = new RouteStepDao();</span>
<span class="nc" id="L321">        RouteStepDto routeStepDto = routeStepDao.getCurrentStep(documentId);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (routeStepDto == null) {</span>
<span class="nc" id="L323">            throw new NotFoundException();</span>
        }

        // Remove the temporary ACLs
<span class="nc" id="L327">        RoutingUtil.updateAcl(documentId, null, routeStepDto, principal.getId());</span>

        // Delete the route and the steps
<span class="nc" id="L330">        RouteDao routeDao = new RouteDao();</span>
<span class="nc" id="L331">        routeDao.deleteRoute(routeStepDto.getRouteId(), principal.getId());</span>

        // Always return OK
<span class="nc" id="L334">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L335">                .add(&quot;status&quot;, &quot;ok&quot;);</span>
<span class="nc" id="L336">        return Response.ok().entity(response.build()).build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>