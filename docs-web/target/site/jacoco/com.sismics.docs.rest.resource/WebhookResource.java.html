<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebhookResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Docs Web</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.rest.resource</a> &gt; <span class="el_source">WebhookResource.java</span></div><h1>WebhookResource.java</h1><pre class="source lang-java linenums">package com.sismics.docs.rest.resource;

import com.sismics.docs.core.constant.WebhookEvent;
import com.sismics.docs.core.dao.WebhookDao;
import com.sismics.docs.core.dao.criteria.WebhookCriteria;
import com.sismics.docs.core.dao.dto.WebhookDto;
import com.sismics.docs.core.model.jpa.Webhook;
import com.sismics.docs.core.util.jpa.SortCriteria;
import com.sismics.docs.rest.constant.BaseFunction;
import com.sismics.rest.exception.ForbiddenClientException;
import com.sismics.rest.util.ValidationUtil;

import javax.json.Json;
import javax.json.JsonArrayBuilder;
import javax.json.JsonObjectBuilder;
import javax.ws.rs.*;
import javax.ws.rs.core.Response;
import java.util.List;

/**
 * Webhook REST resources.
 * 
 * @author bgamard
 */
@Path(&quot;/webhook&quot;)
<span class="nc" id="L26">public class WebhookResource extends BaseResource {</span>
    /**
     * Returns the list of all webhooks.
     *
     * @api {get} /webhook Get webhooks
     * @apiName GetWebhook
     * @apiGroup Webhook
     * @apiSuccess {Object[]} webhooks List of webhooks
     * @apiSuccess {String} webhooks.id ID
     * @apiSuccess {String} webhooks.event Event
     * @apiSuccess {String} webhooks.url URL
     * @apiError (client) ForbiddenError Access denied
     * @apiPermission admin
     * @apiVersion 1.6.0
     *
     * @return Response
     */
    @GET
    public Response list(@QueryParam(&quot;document&quot;) String documentId) {
<span class="nc bnc" id="L45" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L46">            throw new ForbiddenClientException();</span>
        }
<span class="nc" id="L48">        checkBaseFunction(BaseFunction.ADMIN);</span>

<span class="nc" id="L50">        WebhookDao webhookDao = new WebhookDao();</span>
<span class="nc" id="L51">        JsonArrayBuilder webhooks = Json.createArrayBuilder();</span>
<span class="nc" id="L52">        List&lt;WebhookDto&gt; webhookDtoList = webhookDao.findByCriteria(new WebhookCriteria(), new SortCriteria(2, true));</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">        for (WebhookDto webhookDto : webhookDtoList) {</span>
<span class="nc" id="L54">            webhooks.add(Json.createObjectBuilder()</span>
<span class="nc" id="L55">                    .add(&quot;id&quot;, webhookDto.getId())</span>
<span class="nc" id="L56">                    .add(&quot;event&quot;, webhookDto.getEvent())</span>
<span class="nc" id="L57">                    .add(&quot;url&quot;, webhookDto.getUrl())</span>
<span class="nc" id="L58">                    .add(&quot;create_date&quot;, webhookDto.getCreateTimestamp()));</span>
<span class="nc" id="L59">        }</span>

<span class="nc" id="L61">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L62">                .add(&quot;webhooks&quot;, webhooks);</span>
<span class="nc" id="L63">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Add a webhook.
     *
     * @api {put} /webhook Add a webhook
     * @apiDescription Each time the specified event is raised, the webhook URL will be POST-ed with the following JSON payload: {&quot;event&quot;: &quot;Event name&quot;, &quot;id&quot;: &quot;ID of the document or file&quot;}
     * @apiName PutWebhook
     * @apiGroup Webhook
     * @apiParam {String=&quot;DOCUMENT_CREATED&quot;,&quot;DOCUMENT_UPDATED&quot;,&quot;DOCUMENT_DELETED&quot;,&quot;FILE_CREATED&quot;,&quot;FILE_UPDATED&quot;,&quot;FILE_DELETED&quot;} event Event
     * @apiParam {String} url URL
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiPermission admin
     * @apiVersion 1.6.0
     *
     * @return Response
     */
    @PUT
    public Response add(@FormParam(&quot;event&quot;) String eventStr,
                        @FormParam(&quot;url&quot;) String url) {
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L87">            throw new ForbiddenClientException();</span>
        }
<span class="nc" id="L89">        checkBaseFunction(BaseFunction.ADMIN);</span>

        // Validate input
<span class="nc" id="L92">        WebhookEvent event = WebhookEvent.valueOf(ValidationUtil.validateLength(eventStr, &quot;event&quot;, 1, 50, false));</span>
<span class="nc" id="L93">        url = ValidationUtil.validateLength(url, &quot;url&quot;, 1, 1024, false);</span>

        // Create the webhook
<span class="nc" id="L96">        WebhookDao webhookDao = new WebhookDao();</span>
<span class="nc" id="L97">        webhookDao.create(new Webhook()</span>
<span class="nc" id="L98">                .setUrl(url)</span>
<span class="nc" id="L99">                .setEvent(event));</span>

        // Always return OK
<span class="nc" id="L102">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L103">                .add(&quot;status&quot;, &quot;ok&quot;);</span>
<span class="nc" id="L104">        return Response.ok().entity(response.build()).build();</span>
    }

    /**
     * Delete a webhook.
     *
     * @api {delete} /webhook/:id Delete a webhook
     * @apiName DeleteWebhook
     * @apiGroup Webhook
     * @apiParam {String} id Webhook ID
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) NotFound Webhook not found
     * @apiPermission admin
     * @apiVersion 1.6.0
     *
     * @return Response
     */
    @DELETE
    @Path(&quot;{id: [a-z0-9\\-]+}&quot;)
    public Response delete(@PathParam(&quot;id&quot;) String id) {
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L126">            throw new ForbiddenClientException();</span>
        }
<span class="nc" id="L128">        checkBaseFunction(BaseFunction.ADMIN);</span>

        // Get the webhook
<span class="nc" id="L131">        WebhookDao webhookDao = new WebhookDao();</span>
<span class="nc" id="L132">        Webhook webhook = webhookDao.getActiveById(id);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (webhook == null) {</span>
<span class="nc" id="L134">            throw new NotFoundException();</span>
        }

        // Delete the webhook
<span class="nc" id="L138">        webhookDao.delete(webhook.getId());</span>

        // Always return OK
<span class="nc" id="L141">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="nc" id="L142">                .add(&quot;status&quot;, &quot;ok&quot;);</span>
<span class="nc" id="L143">        return Response.ok().entity(response.build()).build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>