<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AclResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Docs Web</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.rest.resource</a> &gt; <span class="el_source">AclResource.java</span></div><h1>AclResource.java</h1><pre class="source lang-java linenums">package com.sismics.docs.rest.resource;

import com.google.common.collect.Lists;
import com.sismics.docs.core.constant.AclTargetType;
import com.sismics.docs.core.constant.AclType;
import com.sismics.docs.core.constant.PermType;
import com.sismics.docs.core.dao.*;
import com.sismics.docs.core.dao.criteria.GroupCriteria;
import com.sismics.docs.core.dao.criteria.UserCriteria;
import com.sismics.docs.core.dao.dto.GroupDto;
import com.sismics.docs.core.dao.dto.UserDto;
import com.sismics.docs.core.event.AclCreatedAsyncEvent;
import com.sismics.docs.core.event.AclDeletedAsyncEvent;
import com.sismics.docs.core.model.jpa.Acl;
import com.sismics.docs.core.model.jpa.Document;
import com.sismics.docs.core.model.jpa.Tag;
import com.sismics.docs.core.util.SecurityUtil;
import com.sismics.docs.core.util.jpa.SortCriteria;
import com.sismics.rest.exception.ClientException;
import com.sismics.rest.exception.ForbiddenClientException;
import com.sismics.rest.util.ValidationUtil;
import com.sismics.util.context.ThreadLocalContext;

import javax.json.Json;
import javax.json.JsonArrayBuilder;
import javax.json.JsonObjectBuilder;
import javax.ws.rs.*;
import javax.ws.rs.core.Response;
import java.text.MessageFormat;
import java.util.List;

/**
 * ACL REST resources.
 * 
 * @author bgamard
 */
@Path(&quot;/acl&quot;)
<span class="fc" id="L38">public class AclResource extends BaseResource {</span>
    /**
     * Add an ACL.
     *
     * @api {put} /acl Add an ACL
     * @apiName PutAcl
     * @apiGroup Acl
     * @apiParam {String} source Source ID
     * @apiParam {String=&quot;READ&quot;,&quot;WRITE&quot;} perm Permission
     * @apiParam {String} target Target ID
     * @apiParam {String=&quot;USER&quot;,&quot;GROUP&quot;,&quot;SHARE&quot;} type Target type
     * @apiSuccess {String} id Acl ID
     * @apiSuccess {String} perm Permission
     * @apiSuccess {String} name Target name
     * @apiSuccess {String=&quot;USER&quot;,&quot;GROUP&quot;,&quot;SHARE&quot;} type Target type
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiError (client) InvalidTarget This target does not exist
     * @apiPermission user
     * @apiVersion 1.5.0
     *
     * @param sourceId Source ID
     * @param permStr Permission
     * @param targetName Target name
     * @param typeStr ACL type
     * @return Response
     */
    @PUT
    public Response add(@FormParam(&quot;source&quot;) String sourceId,
            @FormParam(&quot;perm&quot;) String permStr,
            @FormParam(&quot;target&quot;) String targetName,
            @FormParam(&quot;type&quot;) String typeStr) {
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L71">            throw new ForbiddenClientException();</span>
        }
        
        // Validate input
<span class="fc" id="L75">        ValidationUtil.validateRequired(sourceId, &quot;source&quot;);</span>
<span class="fc" id="L76">        PermType perm = PermType.valueOf(ValidationUtil.validateLength(permStr, &quot;perm&quot;, 1, 30, false));</span>
<span class="fc" id="L77">        AclTargetType type = AclTargetType.valueOf(ValidationUtil.validateLength(typeStr, &quot;type&quot;, 1, 10, false));</span>
<span class="fc" id="L78">        targetName = ValidationUtil.validateLength(targetName, &quot;target&quot;, 1, 50, false);</span>
        
        // Does a target has been found?
<span class="fc" id="L81">        String targetId = SecurityUtil.getTargetIdFromName(targetName, type);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (targetId == null) {</span>
<span class="nc" id="L83">            throw new ClientException(&quot;InvalidTarget&quot;, MessageFormat.format(&quot;This target does not exist: {0}&quot;, targetName));</span>
        }
        
        // Check permission on the source by the principal
<span class="fc" id="L87">        AclDao aclDao = new AclDao();</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        if (!aclDao.checkPermission(sourceId, PermType.WRITE, getTargetIdList(null))) {</span>
<span class="nc" id="L89">            throw new ForbiddenClientException();</span>
        }
        
        // Create the ACL
<span class="fc" id="L93">        Acl acl = new Acl();</span>
<span class="fc" id="L94">        acl.setSourceId(sourceId);</span>
<span class="fc" id="L95">        acl.setPerm(perm);</span>
<span class="fc" id="L96">        acl.setTargetId(targetId);</span>
<span class="fc" id="L97">        acl.setType(AclType.USER);</span>
        
        // Avoid duplicates
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (!aclDao.checkPermission(acl.getSourceId(), acl.getPerm(), Lists.newArrayList(acl.getTargetId()))) {</span>
<span class="fc" id="L101">            aclDao.create(acl, principal.getId());</span>

            // Raise an ACL created event
<span class="fc" id="L104">            AclCreatedAsyncEvent event = new AclCreatedAsyncEvent();</span>
<span class="fc" id="L105">            event.setUserId(principal.getId());</span>
<span class="fc" id="L106">            event.setSourceId(sourceId);</span>
<span class="fc" id="L107">            event.setPerm(perm);</span>
<span class="fc" id="L108">            event.setTargetId(targetId);</span>
<span class="fc" id="L109">            ThreadLocalContext.get().addAsyncEvent(event);</span>

            // Returns the ACL
<span class="fc" id="L112">            JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="fc" id="L113">                    .add(&quot;perm&quot;, acl.getPerm().name())</span>
<span class="fc" id="L114">                    .add(&quot;id&quot;, acl.getTargetId())</span>
<span class="fc" id="L115">                    .add(&quot;name&quot;, targetName)</span>
<span class="fc" id="L116">                    .add(&quot;type&quot;, type.name());</span>
<span class="fc" id="L117">            return Response.ok().entity(response.build()).build();</span>
        }
        
<span class="fc" id="L120">        return Response.ok().entity(Json.createObjectBuilder().build()).build();</span>
    }
    
    /**
     * Deletes an ACL.
     *
     * @api {delete} /acl/:source/:perm/:target Delete an ACL
     * @apiName DeleteAcl
     * @apiGroup Acl
     * @apiParam {String} source Source ID
     * @apiParam {String=&quot;READ&quot;,&quot;WRITE&quot;} perm Permission
     * @apiParam {String} target Target ID
     * @apiSuccess {String} status Status OK
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiError (client) AclError Cannot delete base ACL on a document or a tag
     * @apiPermission user
     * @apiVersion 1.5.0
     * 
     * @param sourceId Source ID
     * @param permStr Permission
     * @param targetId Target ID
     * @return Response
     */
    @DELETE
    @Path(&quot;{sourceId: [a-z0-9\\-]+}/{perm: [A-Z]+}/{targetId: [a-z0-9\\-]+}&quot;)
    public Response delete(
            @PathParam(&quot;sourceId&quot;) String sourceId,
            @PathParam(&quot;perm&quot;) String permStr,
            @PathParam(&quot;targetId&quot;) String targetId) {
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L151">            throw new ForbiddenClientException();</span>
        }
        
        // Validate input
<span class="fc" id="L155">        ValidationUtil.validateRequired(sourceId, &quot;source&quot;);</span>
<span class="fc" id="L156">        PermType perm = PermType.valueOf(ValidationUtil.validateLength(permStr, &quot;perm&quot;, 1, 30, false));</span>
<span class="fc" id="L157">        ValidationUtil.validateRequired(targetId, &quot;target&quot;);</span>

        // Check permission on the source by the principal
<span class="fc" id="L160">        AclDao aclDao = new AclDao();</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">        if (!aclDao.checkPermission(sourceId, PermType.WRITE, getTargetIdList(null))) {</span>
<span class="fc" id="L162">            throw new ForbiddenClientException();</span>
        }
        
        // Cannot delete R/W on a source document if the target is the creator
<span class="fc" id="L166">        DocumentDao documentDao = new DocumentDao();</span>
<span class="fc" id="L167">        Document document = documentDao.getById(sourceId);</span>
<span class="pc bpc" id="L168" title="1 of 4 branches missed.">        if (document != null &amp;&amp; document.getUserId().equals(targetId)) {</span>
<span class="fc" id="L169">            throw new ClientException(&quot;AclError&quot;, &quot;Cannot delete base ACL on a document&quot;);</span>
        }

        // Cannot delete R/W on a source tag if the target is the creator
<span class="fc" id="L173">        TagDao tagDao = new TagDao();</span>
<span class="fc" id="L174">        Tag tag = tagDao.getById(sourceId);</span>
<span class="pc bpc" id="L175" title="3 of 4 branches missed.">        if (tag != null &amp;&amp; tag.getUserId().equals(targetId)) {</span>
<span class="nc" id="L176">            throw new ClientException(&quot;AclError&quot;, &quot;Cannot delete base ACL on a tag&quot;);</span>
        }

        // Delete the ACL
<span class="fc" id="L180">        aclDao.delete(sourceId, perm, targetId, principal.getId(), AclType.USER);</span>

        // Raise an ACL deleted event
<span class="fc" id="L183">        AclDeletedAsyncEvent event = new AclDeletedAsyncEvent();</span>
<span class="fc" id="L184">        event.setUserId(principal.getId());</span>
<span class="fc" id="L185">        event.setSourceId(sourceId);</span>
<span class="fc" id="L186">        event.setPerm(perm);</span>
<span class="fc" id="L187">        event.setTargetId(targetId);</span>
<span class="fc" id="L188">        ThreadLocalContext.get().addAsyncEvent(event);</span>
        
        // Always return OK
<span class="fc" id="L191">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="fc" id="L192">                .add(&quot;status&quot;, &quot;ok&quot;);</span>
<span class="fc" id="L193">        return Response.ok().entity(response.build()).build();</span>
    }
    
    /**
     * Search possible ACL target.
     *
     * @api {get} /acl/target/search Search in ACL targets
     * @apiName GetAclTargetSearch
     * @apiGroup Acl
     * @apiParam {String} search Search query
     * @apiSuccess {Object[]} users List of users
     * @apiSuccess {String} users.name Username
     * @apiSuccess {Object[]} groups List of groups
     * @apiSuccess {String} groups.name Group name
     * @apiError (client) ForbiddenError Access denied
     * @apiError (client) ValidationError Validation error
     * @apiPermission user
     * @apiVersion 1.5.0
     * 
     * @param search Search query
     * @return Response
     */
    @GET
    @Path(&quot;target/search&quot;)
    public Response targetList(@QueryParam(&quot;search&quot;) String search) {
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">        if (!authenticate()) {</span>
<span class="nc" id="L219">            throw new ForbiddenClientException();</span>
        }
        
        // Validate input
<span class="fc" id="L223">        search = ValidationUtil.validateLength(search, &quot;search&quot;, 1, 50, false);</span>
        
        // Search users
<span class="fc" id="L226">        UserDao userDao = new UserDao();</span>
<span class="fc" id="L227">        JsonArrayBuilder users = Json.createArrayBuilder();</span>
<span class="fc" id="L228">        SortCriteria sortCriteria = new SortCriteria(1, true);</span>
<span class="fc" id="L229">        List&lt;UserDto&gt; userDtoList = userDao.findByCriteria(new UserCriteria().setSearch(search), sortCriteria);</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">        for (UserDto userDto : userDtoList) {</span>
            // No need to add users who will skip ACL check anyways
<span class="fc bfc" id="L232" title="All 2 branches covered.">            if (!SecurityUtil.skipAclCheck(Lists.newArrayList(userDto.getId()))) {</span>
<span class="fc" id="L233">                users.add(Json.createObjectBuilder()</span>
<span class="fc" id="L234">                        .add(&quot;name&quot;, userDto.getUsername()));</span>
            }
<span class="fc" id="L236">        }</span>
        
        // Search groups
<span class="fc" id="L239">        GroupDao groupDao = new GroupDao();</span>
<span class="fc" id="L240">        JsonArrayBuilder groups = Json.createArrayBuilder();</span>
<span class="fc" id="L241">        List&lt;GroupDto&gt; groupDtoList = groupDao.findByCriteria(new GroupCriteria().setSearch(search), sortCriteria);</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">        for (GroupDto groupDto : groupDtoList) {</span>
            // No need to add users who will skip ACL check anyways
<span class="fc bfc" id="L244" title="All 2 branches covered.">            if (!SecurityUtil.skipAclCheck(Lists.newArrayList(groupDto.getId()))) {</span>
<span class="fc" id="L245">                groups.add(Json.createObjectBuilder()</span>
<span class="fc" id="L246">                        .add(&quot;name&quot;, groupDto.getName()));</span>
            }
<span class="fc" id="L248">        }</span>
        
<span class="fc" id="L250">        JsonObjectBuilder response = Json.createObjectBuilder()</span>
<span class="fc" id="L251">                .add(&quot;users&quot;, users)</span>
<span class="fc" id="L252">                .add(&quot;groups&quot;, groups);</span>
<span class="fc" id="L253">        return Response.ok().entity(response.build()).build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>